/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */
(function(a){Craft.Dashboard=Garnish.Base.extend({$alerts:null,$container:null,widgets:null,cols:null,colWidth:null,loadingWidget:-1,init:function(){this.$alerts=a("#alerts");this.$container=a("#widgets");this.widgets=[];var c=this.$container.children();this.setCols();for(var d=0;d<c.length;d++){var e=a(c[d]);this.placeWidget(e);this.widgets.push(e)}this.stretchColHeights();this.addListener(Garnish.$win,"resize","onWindowResize");if(typeof window.getAlerts!="undefined"&&window.getAlerts){a.getJSON(getAlertsUrl,a.proxy(this,"displayAlerts"))}},onWindowResize:function(){this.setCols();this.stretchColHeights()},setCols:function(){var c=Math.floor(this.$container.width()/Craft.Dashboard.minColWidth);if(c==0){c=1}if(c!==this.totalCols){this.totalCols=c;this.refreshCols();return true}return false},refreshCols:function(){for(var f=0;f<this.widgets.length;f++){this.widgets[f].detach()}if(this.cols){for(var e=0;e<this.cols.length;e++){this.cols[e].remove()}}this.cols=[];this.colWidth=Math.floor(10000/this.totalCols)/100;for(var d=0;d<this.totalCols;d++){this.cols[d]=new b(this,d)}for(var c=0;c<this.widgets.length;c++){this.placeWidget(this.widgets[c])}},placeWidget:function(d){var c=this.getShortestCol();c.addWidget(d)},getShortestCol:function(){var f,e;for(var d=0;d<this.cols.length;d++){var c=this.cols[d],g=this.cols[d].getHeight();if(typeof f=="undefined"||g<e){f=c;e=g}}return f},getTallestCol:function(){var f,g;for(var d=0;d<this.cols.length;d++){var c=this.cols[d],e=this.cols[d].getHeight();if(typeof f=="undefined"||e>g){f=c;g=e}}return f},stretchColHeights:function(){return;var f=Garnish.$win.height()-101,e=this.getTallestCol(),c=Math.max(f,e.getHeight());for(var d=0;d<this.cols.length;d++){this.cols[d].setHeight(c)}},onWidgetMove:function(){this.getWidgetHandles();for(var c=0;c<this.dom.$widgetHandles.length;c++){var d=this.getWidget(c);if(d){d.elem.css("zIndex",c+1)}}var d=this.getWidget(this.widgetSort.draggeeIndex);if(d){this.refreshCols(true)}},onWidgetRemove:function(h){var j=a(h.currentTarget).parent(),e=j.outerHeight();j.animate({opacity:0,marginBottom:-e},function(){j.remove()});var i=this.getWidgetFromHandle(j);if(i){var g=this.$container.offset(),d=i.$elem.offset(),f=i.$elem.width();i.$elem.appendTo(this.$container);i.$elem.css({position:"absolute",display:"block",zIndex:0,top:d.top-g.top,left:d.left-g.left,width:f});i.$elem.fadeOut(a.proxy(function(){i.$elem.remove()},this))}var c=a.inArray(j[0],this.dom.$widgetHandles);this.dom.$widgetHandles.splice(c,1);this.refreshCols(true)},displayAlerts:function(g,j){if(g&&j=="success"&&g.alerts.length){var c=this.$alerts.height(),h=[];for(var d=0;d<g.alerts.length;d++){var f=a('<div class="alert"><p>'+g.alerts[d]+"</p></div>");this.$alerts.append(f);f.css({opacity:0});f.delay((d+1)*100).animate({opacity:1})}var e=this.$alerts.height()+20;this.$alerts.height(c);this.$alerts.animate({height:e},a.proxy(function(){this.$alerts.height("auto")},this))}}},{minColWidth:325});var b=Garnish.Base.extend({dashboard:null,index:null,$outerContainer:null,$innerContainer:null,init:function(c,d){this.dashboard=c;this.index=d;this.$outerContainer=a('<div class="col" style="width: '+this.dashboard.colWidth+'%"/>').appendTo(this.dashboard.$container);this.$innerContainer=a('<div class="col-inner">').appendTo(this.$outerContainer)},getHeight:function(){this.$innerContainer.height("auto");return this.$outerContainer.height()},setHeight:function(c){this.$innerContainer.height(c)},addWidget:function(c){this.$innerContainer.append(c)},remove:function(){this.$outerContainer.remove()}});Craft.dashboard=new Craft.Dashboard()})(jQuery);