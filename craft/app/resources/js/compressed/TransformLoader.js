/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */
TransformLoader=function(d,b,c){this.placeholderUrl=d;this.spinnerUrl=b;this.generateTransformUrl=c;var a=new Image();a.onload=this.bind("init");a.src=b};TransformLoader.prototype={bind:function(b,a){var c=this;return function(){c[b].apply(c,a)}},insertAfter:function(a,b){if(b.nextSibling){b.parentNode.insertBefore(a,b.nextSibling)}else{b.parentNode.appendChild(a)}},init:function(){this.escapedPlaceholderUrl=this.placeholderUrl.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");this.placeholderUrlPattern=this.escapedPlaceholderUrl+"#(\\d+)\\b";this.placeholderUrlRegex=new RegExp(this.placeholderUrlPattern);this.multiPlaceholderUrlRegex=new RegExp(this.placeholderUrlPattern,"g");this.transforms={};this.totalTransforms=0;this.pendingTransforms=0;var d=document.head.innerHTML+document.body.innerHTML,h=d.match(this.multiPlaceholderUrlRegex);if(h){for(var g=0;g<h.length;g++){var k=h[g].match(this.placeholderUrlRegex),a=k[1];if(typeof this.transforms[a]=="undefined"){this.transforms[a]={imageTags:[],styleTags:[]};this.totalTransforms++;this.pendingTransforms++}}}if(!this.totalTransforms){return}var m=document.getElementsByTagName("img"),c=document.getElementsByTagName("style"),b=m.length,p=c.length;for(var g=0;g<b;g++){var k=m[g].src.match(this.placeholderUrlRegex);if(k){this.transforms[k[1]].imageTags.push({tag:m[g],originalBgColor:m[g].style.backgroundColor,originalBgImage:m[g].style.backgroundImage,originalBgRepeat:m[g].style.backgroundRepeat,originalBgPosition:m[g].style.backgroundPosition,originalBgSize:m[g].style.backgroundSize});m[g].style.backgroundColor="#f5f5f5";m[g].style.backgroundImage="url("+this.spinnerUrl+")";m[g].style.backgroundRepeat="no-repeat";m[g].style.backgroundPosition="50% 50%";m[g].style.backgroundSize="48px"}}var n=new RegExp(this.placeholderUrlPattern+"[^}]*","g");for(var g=0;g<p;g++){var h=c[g].innerHTML.match(n);if(h&&h.length){var e=document.createElement("style");e.setAttribute("type","text/css");var l=c[g].innerHTML;for(var f=0;f<h.length;f++){var o=h[f]+" background: #f5f5f5 url("+this.spinnerUrl+") no-repeat 50% 50% !important; background-size: 48px !important";l=l.replace(h[f],o);var k=h[f].match(this.placeholderUrlRegex),a=k[1];this.transforms[a].styleTags.push({tag:c[g],tempTag:e,originalCss:h[f],tempCss:o})}e.innerHTML=l;this.insertAfter(e,c[g])}}setTimeout(this.bind("makeGenerateTransformRequests"),500)},makeGenerateTransformRequests:function(){for(var a in this.transforms){this.makeGenerateTransformRequest(a)}},makeGenerateTransformRequest:function(a){var b=new XMLHttpRequest();b.onreadystatechange=this.getGenerateTransformResponseFunction(a,b);b.open("POST",this.generateTransformUrl,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.setRequestHeader("X-Requested-With","XMLHttpRequest");b.send("transformId="+a)},getGenerateTransformResponseFunction:function(a,c){var b=this;return function(){b.onTransformResponse.call(b,a,c)}},onTransformResponse:function(b,e){if(e.readyState==4&&e.status==200){if(e.responseText=="working"){var d=this;setTimeout(function(){d.makeGenerateTransformRequest(b)},1000);return}if(e.responseText.substr(0,8)=="success:"){var a=e.responseText.substr(8);var c=new Image();c.onload=this.bind("replaceTransformImages",[b,a]);c.src=a}}this.pendingTransforms--},replaceTransformImages:function(e,d){var g=new RegExp(this.escapedPlaceholderUrl+"#"+e+"\\b","g");for(var f=0;f<this.transforms[e].imageTags.length;f++){var b=this.transforms[e].imageTags[f];b.tag.src=b.tag.src.replace(g,d);b.tag.style.backgroundColor=b.originalBgColor;b.tag.style.backgroundImage=b.originalBgImage;b.tag.style.backgroundRepeat=b.originalBgRepeat;b.tag.style.backgroundPosition=b.originalBgPosition;b.tag.style.backgroundSize=b.originalBgSize}for(var f=0;f<this.transforms[e].styleTags.length;f++){var a=this.transforms[e].styleTags[f];var c=a.tempTag.innerHTML.replace(a.tempCss,a.originalCss);c=c.replace(g,d);a.tempTag.innerHTML=c}}};