/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */
(function($){if(typeof Craft=="undefined"){Craft={}}$.extend(Craft,{navHeight:48,asciiCharMap:{"223":"ss","224":"a","225":"a","226":"a","229":"a","227":"ae","230":"ae","228":"ae","231":"c","232":"e","233":"e","234":"e","235":"e","236":"i","237":"i","238":"i","239":"i","241":"n","242":"o","243":"o","244":"o","245":"o","246":"oe","249":"u","250":"u","251":"u","252":"ue","255":"y","257":"aa","269":"ch","275":"ee","291":"gj","299":"ii","311":"kj","316":"lj","326":"nj","353":"sh","363":"uu","382":"zh","256":"aa","268":"ch","274":"ee","290":"gj","298":"ii","310":"kj","315":"lj","325":"nj","352":"sh","362":"uu","381":"zh"},t:function(message,params){if(typeof Craft.translations[message]!="undefined"){message=Craft.translations[message]}if(params){for(var key in params){message=message.replace("{"+key+"}",params[key])}}return message},hasPackage:function(pkg){return($.inArray(pkg,Craft.packages)!=-1)},getUrl:function(path,params,baseUrl){if(path.search("://")!=-1||path.substr(0,2)=="//"){return path}path=Craft.trim(path,"/");var anchor="";if($.isPlainObject(params)){var aParams=[];for(var name in params){var value=params[name];if(name=="#"){anchor=value}else{if(value!==null&&value!==""){aParams.push(name+"="+value)}}}params=aParams}if(Garnish.isArray(params)){params=params.join("&")}else{params=Craft.ltrim(params,"&")}if(baseUrl){var url=baseUrl}else{var url=Craft.baseUrl}var qsMarker=url.indexOf("?");if(qsMarker!="-1"){var qs=url.substr(qsMarker+1);url=url.substr(0,qsMarker);if(qs){params=qs+(params?"&"+params:"")}}if(!Craft.usePathInfo&&path){if(params&&params.substr(0,2)=="p="){var endPath=params.indexOf("&");if(endPath!=-1){var basePath=params.substring(2,endPath-1);params=params.substr(endPath+1)}else{var basePath=params.substr(2);params=null}path=basePath+(path?"/"+path:"")}params="p="+path+(params?"&"+params:"");path=null}if(path){url+="/"+path}if(params){url+="?"+params}if(anchor){url+="#"+anchor}return url},getCpUrl:function(path,params){return this.getUrl(path,params,Craft.baseCpUrl)},getSiteUrl:function(path,params){return this.getUrl(path,params,Craft.baseSiteUrl)},getResourceUrl:function(path,params){path=Craft.resourceTrigger+"/"+Craft.trim(path,"/");return Craft.getUrl(path,params)},getActionUrl:function(path,params){path=Craft.actionTrigger+"/"+Craft.trim(path,"/");return Craft.getUrl(path,params)},postActionRequest:function(action,data,onSuccess,onError){var url=Craft.getActionUrl(action);if(typeof data=="function"){onError=onSuccess;onSuccess=data;data={}}return $.ajax(url,{type:"POST",data:data,success:onSuccess,error:onError})},stringToArray:function(str){if(typeof str!="string"){return str}var arr=str.split(",");for(var i=0;i<arr.length;i++){arr[i]=$.trim(arr[i])}return arr},expandPostArray:function(arr){var expanded={};for(var key in arr){var value=arr[key],m=key.match(/^(\w+)(\[.*)?/);if(m[2]){var keys=m[2].match(/\[[^\[\]]*\]/g);for(var i=0;i<keys.length;i++){keys[i]=keys[i].substring(1,keys[i].length-1)}}else{var keys=[]}keys.unshift(m[1]);var parentElem=expanded;for(var i=0;i<keys.length;i++){if(i<keys.length-1){if(typeof parentElem[keys[i]]!="object"){if(!keys[i+1]||parseInt(keys[i+1])==keys[i+1]){parentElem[keys[i]]=[]}else{parentElem[keys[i]]={}}}parentElem=parentElem[keys[i]]}else{if(!keys[i]){keys[i]=parentElem.length}parentElem[keys[i]]=value}}}return expanded},compare:function(obj1,obj2){if(typeof obj1!=typeof obj2){return false}if(typeof obj1=="object"){if(obj1.length!=obj2.length){return false}if((obj1 instanceof Array)!=(obj2 instanceof Array)){return false}if(!(obj1 instanceof Array)){if(!Craft.compare(Craft.getObjectKeys(obj1),Craft.getObjectKeys(obj2))){return false}}for(var i in obj1){if(!Craft.compare(obj1[i],obj2[i])){return false}}return true}else{return(obj1===obj2)}},getObjectKeys:function(obj){var keys=[];for(var key in obj){keys.push(key)}return keys},escapeChars:function(chars){if(!Garnish.isArray(chars)){chars=chars.split()}var escaped="";for(var i=0;i<chars.length;i++){escaped+="\\"+chars[i]}return escaped},ltrim:function(str,chars){if(!str){return str}if(chars===undefined){chars=" "}var re=new RegExp("^["+Craft.escapeChars(chars)+"]+");return str.replace(re,"")},rtrim:function(str,chars){if(!str){return str}if(chars===undefined){chars=" "}var re=new RegExp("["+Craft.escapeChars(chars)+"]+$");return str.replace(re,"")},trim:function(str,chars){str=Craft.ltrim(str,chars);str=Craft.rtrim(str,chars);return str},filterArray:function(arr,callback){var filtered=[];for(var i=0;i<arr.length;i++){if(typeof callback=="function"){var include=callback(arr[i],i)}else{var include=arr[i]}if(include){filtered.push(arr[i])}}return filtered},inArray:function(elem,arr){return($.inArray(elem,arr)!=-1)},removeFromArray:function(elem,arr){var index=$.inArray(elem,arr);if(index!=-1){arr.splice(index,1);return true}else{return false}},getLast:function(arr){if(!arr.length){return null}else{return arr[arr.length-1]}},uppercaseFirst:function(str){return str.charAt(0).toUpperCase()+str.slice(1)},lowercaseFirst:function(str){return str.charAt(0).toLowerCase()+str.slice(1)},asciiString:function(str){var asciiStr="";for(var c=0;c<str.length;c++){var ascii=str.charCodeAt(c);if(ascii>=32&&ascii<128){asciiStr+=str.charAt(c)}else{if(typeof Craft.asciiCharMap[ascii]!="undefined"){asciiStr+=Craft.asciiCharMap[ascii]}}}return asciiStr},preventOutlineOnMouseFocus:function(elem){var $elem=$(elem),namespace=".preventOutlineOnMouseFocus";$elem.on("mousedown"+namespace,function(){$elem.addClass("no-outline");$elem.focus()}).on("keydown"+namespace+" blur"+namespace,function(event){if(event.keyCode!=Garnish.SHIFT_KEY&&event.keyCode!=Garnish.CTRL_KEY&&event.keyCode!=Garnish.CMD_KEY){$elem.removeClass("no-outline")}})},createErrorList:function(errors){var $ul=$(document.createElement("ul")).addClass("errors");for(var i=0;i<errors.length;i++){var $li=$(document.createElement("li"));$li.appendTo($ul);$li.html(errors[i])}return $ul},initUiElements:function($container){$(".checkbox-select",$container).checkboxselect();$(".fieldtoggle",$container).fieldtoggle();$(".lightswitch",$container).lightswitch();$(".nicetext",$container).nicetext();$("input.password",$container).passwordinput();$(".pill",$container).pill();$(".menubtn",$container).menubtn()},_elementIndexClasses:{},_elementSelectorModalClasses:{},registerElementIndexClass:function(elementType,func){if(typeof this._elementIndexClasses[elementType]!="undefined"){throw"An element index class has already been registered for the element type “"+elementType+"”."}this._elementIndexClasses[elementType]=func},registerElementSelectorModalClass:function(elementType,func){if(typeof this._elementSelectorModalClasses[elementType]!="undefined"){throw"An element selector modal class has already been registered for the element type “"+elementType+"”."}this._elementSelectorModalClasses[elementType]=func},createElementIndex:function(elementType,$container,settings){if(typeof this._elementIndexClasses[elementType]!="undefined"){var func=this._elementIndexClasses[elementType]}else{var func=Craft.BaseElementIndex}return new func(elementType,$container,settings)},createElementSelectorModal:function(elementType,settings){if(typeof this._elementSelectorModalClasses[elementType]!="undefined"){var func=this._elementSelectorModalClasses[elementType]}else{var func=Craft.BaseElementSelectorModal}return new func(elementType,settings)}});$.extend($.fn,{disable:function(){return this.each(function(){var $elem=$(this);$elem.addClass("disabled");if($elem.data("activatable")){$elem.removeAttr("tabindex")}})},enable:function(){return this.each(function(){var $elem=$(this);$elem.removeClass("disabled");if($elem.data("activatable")){$elem.attr("tabindex","0")}})},checkboxselect:function(){return this.each(function(){if(!$.data(this,"checkboxselect")){new Garnish.CheckboxSelect(this)}})},fieldtoggle:function(){return this.each(function(){if(!$.data(this,"fieldtoggle")){new Craft.FieldToggle(this)}})},lightswitch:function(settings,settingName,settingValue){if(settings=="settings"){if(typeof settingName=="string"){settings={};settings[settingName]=settingValue}else{settings=settingName}return this.each(function(){var obj=$.data(this,"lightswitch");if(obj){obj.setSettings(settings)}})}return this.each(function(){if(!$.data(this,"lightswitch")){new Craft.LightSwitch(this,settings)}})},nicetext:function(){},passwordinput:function(){return this.each(function(){if(!$.data(this,"passwordinput")){new Garnish.PasswordInput(this)}})},pill:function(){return this.each(function(){if(!$.data(this,"pill")){new Garnish.Pill(this)}})},menubtn:function(){return this.each(function(){if(!$.data(this,"menubtn")){new Garnish.MenuBtn(this)}})}});Garnish.$doc.ready(function(){Craft.initUiElements()});Craft.BaseElementIndex=Garnish.Base.extend({elementType:null,state:null,stateStorageId:null,searchTimeout:null,elementSelect:null,sourceSelect:null,$container:null,$main:null,$scroller:null,$toolbar:null,$search:null,$viewBtns:null,$viewBtn:null,$mainSpinner:null,$loadingMoreSpinner:null,$sidebar:null,$sources:null,$source:null,$sourceToggles:null,$elements:null,$table:null,$elementContainer:null,init:function(elementType,$container,settings){this.elementType=elementType;this.$container=$container;this.setSettings(settings,Craft.BaseElementIndex.defaults);this.state={};if(typeof Storage!=="undefined"&&this.settings.id){this.stateStorageId="Craft.BaseElementIndex."+this.settings.id;if(typeof localStorage[this.stateStorageId]!="undefined"){$.extend(this.state,JSON.parse(localStorage[this.stateStorageId]))}}this.$main=this.$container.find(".main");this.$toolbar=this.$container.find(".toolbar:first");this.$search=this.$toolbar.find(".search:first input:first");this.$viewBtns=this.$toolbar.find(".btngroup .btn");this.$mainSpinner=this.$toolbar.find(".spinner:first");this.$loadingMoreSpinner=this.$container.find(".spinner.loadingmore");this.$sidebar=this.$container.find(".sidebar:first");this.$sources=this.$sidebar.find("nav a");this.$sourceToggles=this.$sidebar.find(".toggle");this.$elements=this.$container.find(".elements:first");this.onAfterHtmlInit();if(this.settings.mode=="index"){this.$scroller=Garnish.$win}else{this.$scroller=this.$main}var source=this.getState("source");if(source){var $source=this.getSourceByKey(source);if($source){var $parentSources=$source.parentsUntil(".sidebar","li");$parentSources.not(":first").addClass("expanded")}}if(!source||!$source){var $source=this.$sources.first()}this.selectSource($source);var view=this.getState("view");if(view){var $viewBtn=this.$viewBtns.filter("[data-view="+view+"]:first")}if(!view||!$viewBtn.length){var $viewBtn=this.$viewBtns.filter("[data-view=table]:first")}if($viewBtn.length){this.selectView($viewBtn)}else{this.setState("view","table")}this.updateElements();this.addListener(this.$sourceToggles,"click",function(ev){$(ev.currentTarget).parent().toggleClass("expanded");ev.stopPropagation()});this.sourceSelect=new Garnish.Select(this.$sidebar.find("nav"),this.$sources,{selectedClass:"sel",multi:false,waitForDblClick:false,vertical:true,onSelectionChange:$.proxy(this,"_onSourceChange")});this.addListener(this.$viewBtns,"click",function(ev){this.selectView($(ev.currentTarget));this.updateElements()});this.addListener(this.$search,"textchange",$.proxy(function(){if(this.searchTimeout){clearTimeout(this.searchTimeout)}this.searchTimeout=setTimeout($.proxy(this,"updateElements"),500)},this));if(!Garnish.isMobileBrowser(true)){this.$search.focus()}},_onSourceChange:function(){var sourceElement=this.$sources.filter(".sel");if(sourceElement.length==0){sourceElement=this.$sources.filter(":first")}this.selectSource(sourceElement);this.updateElements()},getState:function(key){if(typeof this.state[key]!="undefined"){return this.state[key]}else{return null}},setState:function(key,value){if(typeof key=="object"){$.extend(this.state,key)}else{this.state[key]=value}if(this.stateStorageId){localStorage[this.stateStorageId]=JSON.stringify(this.state)}},getControllerData:function(){return{mode:this.settings.mode,elementType:this.elementType,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,state:this.state,search:(this.$search?this.$search.val():null)}},updateElements:function(){this.$mainSpinner.removeClass("hidden");this.removeListener(this.$scroller,"scroll");if(this.getState("view")=="table"&&this.$table){Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table)}var data=this.getControllerData();Craft.postActionRequest("elements/getElements",data,$.proxy(function(response){this.$mainSpinner.addClass("hidden");this.$elements.html(response.elementContainerHtml);if(this.getState("view")=="table"){var $headers=this.$elements.find("thead:first th");this.addListener($headers,"click","onSortChange");this.$table=this.$elements.find("table:first");this.$elementContainer=this.$table.find("tbody:first");Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table)}else{this.$elementContainer=this.$elements.children("ul")}this.setNewElementDataHtml(response)},this))},setNewElementDataHtml:function(response,append){if(append){this.$elementContainer.append(response.elementDataHtml)}else{this.$elementContainer.html(response.elementDataHtml)}$("head").append(response.headHtml);Craft.cp.setMaxSidebarHeight();if(response.more){this.totalVisible=response.totalVisible;this.addListener(this.$scroller,"scroll",function(){if((this.$scroller[0]==Garnish.$win[0]&&(Garnish.$win.innerHeight()+Garnish.$bod.scrollTop()>=Garnish.$bod.height()))||(this.$scroller.prop("scrollHeight")-this.$scroller.scrollTop()==this.$scroller.outerHeight())){this.$loadingMoreSpinner.removeClass("hidden");this.removeListener(this.$scroller,"scroll");var data=this.getControllerData();data.offset=this.totalVisible;Craft.postActionRequest("elements/getElements",data,$.proxy(function(response){this.$loadingMoreSpinner.addClass("hidden");this.setNewElementDataHtml(response,true)},this))}})}Craft.cp.updateResponsiveTables();this.onUpdateElements(append)},onUpdateElements:function(append){this.settings.onUpdateElements(append)},onSortChange:function(ev){var $th=$(ev.currentTarget),attribute=$th.attr("data-attribute");if(this.getState("order")==attribute){if(this.getState("sort")=="asc"){this.setState("sort","desc")}else{this.setState("sort","asc")}}else{this.setState({order:attribute,sort:"asc"})}this.updateElements()},getSourceByKey:function(key){for(var i=0;i<this.$sources.length;i++){var $source=$(this.$sources[i]);if($source.data("key")==key){return $source}}},selectSource:function($source){if(this.$source){this.$source.removeClass("sel")}var sourceKey=$source.data("key");this.$source=$source.addClass("sel");this.setState("source",sourceKey);this.onSelectSource(sourceKey)},onSelectSource:function(sourceKey){this.settings.onSelectSource(sourceKey)},onAfterHtmlInit:function(){this.settings.onAfterHtmlInit()},selectView:function($viewBtn){if(this.$viewBtn){this.$viewBtn.removeClass("active")}this.$viewBtn=$viewBtn.addClass("active");this.setState("view",$viewBtn.data("view"))},rememberDisabledElementId:function(elementId){var index=$.inArray(elementId,this.settings.disabledElementIds);if(index==-1){this.settings.disabledElementIds.push(elementId)}},forgetDisabledElementId:function(elementId){var index=$.inArray(elementId,this.settings.disabledElementIds);if(index!=-1){this.settings.disabledElementIds.splice(index,1)}},enableElements:function($elements){$elements.removeClass("disabled");for(var i=0;i<$elements.length;i++){var elementId=$($elements[i]).data("id");this.forgetDisabledElementId(elementId)}this.settings.onEnableElements($elements)},disableElements:function($elements){$elements.removeClass("sel").addClass("disabled");for(var i=0;i<$elements.length;i++){var elementId=$($elements[i]).data("id");this.rememberDisabledElementId(elementId)}this.settings.onDisableElements($elements)},getElementById:function(elementId){return this.$elementContainer.children("[data-id="+elementId+"]:first")},enableElementsById:function(elementIds){elementIds=$.makeArray(elementIds);for(var i=0;i<elementIds.length;i++){var elementId=elementIds[i],$element=this.getElementById(elementId);if($element.length){this.enableElements($element)}else{this.forgetDisabledElementId(elementId)}}},disableElementsById:function(elementIds){elementIds=$.makeArray(elementIds);for(var i=0;i<elementIds.length;i++){var elementId=elementIds[i],$element=this.getElementById(elementId);if($element.length){this.disableElements($element)}else{this.rememberDisabledElementId(elementId)}}},setElementSelect:function(obj){this.elementSelect=obj},addCallback:function(currentCallback,newCallback){return $.proxy(function(){if(typeof currentCallback=="function"){currentCallback.apply(this,arguments)}newCallback.apply(this,arguments)},this)},setIndexBusy:function(){this.$mainSpinner.removeClass("hidden");this.isIndexBusy=true},setIndexAvailable:function(){this.$mainSpinner.addClass("hidden");this.isIndexBusy=false}},{defaults:{mode:"index",id:null,criteria:null,disabledElementIds:[],onUpdateElements:$.noop,onEnableElements:$.noop,onDisableElements:$.noop,onSelectSource:$.noop,onAfterHtmlInit:$.noop}});Craft.BaseElementSelectInput=Garnish.Base.extend({id:null,name:null,elementType:null,sources:null,criteria:null,limit:null,totalElements:0,elementSelect:null,elementSort:null,modal:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,init:function(id,name,elementType,sources,criteria,limit){this.id=id;this.name=name;this.elementType=elementType;this.sources=sources;this.criteria=criteria;this.limit=limit;this.$container=$("#"+this.id);this.$elementsContainer=this.$container.children(".elements");this.$elements=this.$elementsContainer.children();this.$addElementBtn=this.$container.children(".btn.add");this.totalElements=this.$elements.length;if(this.limit&&this.totalElements>=this.limit){this.$addElementBtn.addClass("disabled")}this.elementSelect=new Garnish.Select(this.$elements,{multi:true,filter:":not(.delete)"});this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:$.proxy(function(){return this.elementSelect.getSelectedItems()},this),caboose:$('<div class="caboose"/>'),onSortChange:$.proxy(function(){this.elementSelect.resetItemOrder()},this)});this.initElements(this.$elements);this.addListener(this.$addElementBtn,"activate","showModal")},initElements:function($elements){this.elementSelect.addItems($elements);this.elementSort.addItems($elements);$elements.find(".delete").on("click",$.proxy(function(ev){var $element=$(ev.currentTarget).closest(".element");this.$elements=this.$elements.not($element);this.elementSelect.removeItems($element);if(this.modal){this.modal.elementIndex.enableElementsById($element.data("id"))}this.totalElements--;if(this.$addElementBtn){this.$addElementBtn.removeClass("disabled")}$element.css("z-index",0);$element.animate({marginLeft:-($element.outerWidth()+parseInt($element.css("margin-right"))),opacity:-1},"fast",function(){$element.remove()})},this))},showModal:function(){if(this.limit&&this.totalElements==this.limit){return}if(!this.modal){var selectedElementIds=[];for(var i=0;i<this.$elements.length;i++){var $element=$(this.$elements[i]);selectedElementIds.push($element.data("id"))}this.modal=Craft.createElementSelectorModal(this.elementType,{id:this.id,sources:this.sources,criteria:this.criteria,multiSelect:true,disableOnSelect:true,disabledElementIds:selectedElementIds,onSelect:$.proxy(this,"selectElements")})}else{this.modal.show()}},selectElements:function(elements){this.elementSelect.deselectAll();if(this.limit){var slotsLeft=this.limit-this.totalElements,max=Math.min(elements.length,slotsLeft)}else{var max=elements.length}for(var i=0;i<max;i++){var element=elements[i],$newElement=element.$element.clone();$newElement.addClass("removable");$newElement.prepend('<input type="hidden" name="'+this.name+'[]" value="'+element.id+'"><a class="delete icon" title="'+Craft.t("Remove")+'"></a>');$newElement.appendTo(this.$elementsContainer);var origOffset=element.$element.offset(),destOffset=$newElement.offset();$newElement.css({left:origOffset.left-destOffset.left,top:origOffset.top-destOffset.top,zIndex:10000});$newElement.animate({left:0,top:0},function(){$(this).css("z-index",1)});this.$elements=this.$elements.add($newElement);this.initElements($newElement);this.elementSelect.selectItem($newElement)}this.totalElements+=max;if(this.limit&&this.totalElements==this.limit){this.$addElementBtn.addClass("disabled")}}});Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,elementSelect:null,$body:null,$selectBtn:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,init:function(elementType,settings){this.elementType=elementType;this.setSettings(settings,Craft.BaseElementSelectorModal.defaults);var $container=$('<div class="modal elementselectormodal"></div>').appendTo(Garnish.$bod),$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo($container),$footer=$('<div class="footer"/>').appendTo($container),$buttons=$('<div class="buttons rightalign"/>').appendTo($footer),$cancelBtn=$('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo($buttons),$selectBtn=$('<div class="btn disabled submit">'+Craft.t("Select")+"</div>").appendTo($buttons);this.base($container,settings);this.$body=$body;this.$selectBtn=$selectBtn;this.addListener($cancelBtn,"activate","cancel");this.addListener(this.$selectBtn,"activate","selectElements")},onFadeIn:function(){if(!this.elementIndex){var data={mode:"modal",elementType:this.elementType,sources:this.settings.sources};Craft.postActionRequest("elements/getModalBody",data,$.proxy(function(response){this.$body.html(response);this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{mode:"modal",id:this.settings.id,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,onUpdateElements:$.proxy(this,"onUpdateElements"),onEnableElements:$.proxy(this,"onEnableElements"),onDisableElements:$.proxy(this,"onDisableElements")})},this))}else{if(!Garnish.isMobileBrowser(true)){this.elementIndex.$search.focus()}}this.base()},onUpdateElements:function(appended){if(!appended){this.addListener(this.elementIndex.$elementContainer,"dblclick","selectElements")}if(this.elementSelect){this.elementSelect.destroy();delete this.elementSelect}var $trs=this.elementIndex.$elementContainer.children(":not(.disabled)");this.elementSelect=new Garnish.Select(this.elementIndex.$elementContainer,$trs,{multi:this.settings.multiSelect,vertical:(this.elementIndex.getState("view")=="table"),waitForDblClick:true,onSelectionChange:$.proxy(this,"onSelectionChange")});this.elementIndex.setElementSelect(this.elementSelect)},onSelectionChange:function(){if(this.elementSelect.totalSelected){this.$selectBtn.removeClass("disabled")}else{this.$selectBtn.addClass("disabled")}},onEnableElements:function($elements){this.elementSelect.addItems($elements)},onDisableElements:function($elements){this.elementSelect.removeItems($elements)},cancel:function(){this.hide();this.settings.onCancel()},selectElements:function(){if(this.elementIndex&&this.elementSelect&&this.elementSelect.totalSelected){this.elementSelect.clearMouseUpTimeout();var $selectedRows=this.elementSelect.getSelectedItems(),elements=[];for(var i=0;i<$selectedRows.length;i++){var $row=$($selectedRows[i]),$element=$row.find(".element");elements.push({id:$row.data("id"),label:$row.data("label"),status:$row.data("status"),hasThumb:$element.hasClass("hasthumb"),$element:$element})}this.hide();this.settings.onSelect(elements);if(this.settings.disableOnSelect){this.elementIndex.disableElements($selectedRows)}}}},{defaults:{id:null,sources:null,criteria:null,multiSelect:false,disabledElementIds:[],disableOnSelect:false,onCancel:$.noop,onSelect:$.noop}});Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,listening:null,init:function(source,target){this.$source=$(source);this.$target=$(target);this.startListening()},startListening:function(){if(this.listening){return}this.listening=true;this.addListener(this.$source,"textchange","updateTarget");this.addListener(this.$target,"focus",function(){this.addListener(this.$target,"textchange","stopListening");this.addListener(this.$target,"blur",function(){this.removeListener(this.$target,"textchange,blur")})})},stopListening:function(){if(!this.listening){return}this.listening=false;this.removeAllListeners(this.$source);this.removeAllListeners(this.$target)},updateTarget:function(){var sourceVal=this.$source.val(),targetVal=this.generateTargetValue(sourceVal);this.$target.val(targetVal)},generateTargetValue:function(sourceVal){return sourceVal}});Craft.AdminTable=Garnish.Base.extend({settings:null,totalObjects:null,sorter:null,$noObjects:null,$table:null,$tbody:null,$deleteBtns:null,init:function(settings){this.setSettings(settings,Craft.AdminTable.defaults);this.$noObjects=$(this.settings.noObjectsSelector);this.$table=$(this.settings.tableSelector);this.$tbody=this.$table.children("tbody");this.totalObjects=this.$tbody.children().length;if(this.settings.sortable){this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:$.proxy(this,"reorderObjects")})}this.$deleteBtns=this.$table.find(".delete");this.addListener(this.$deleteBtns,"click","deleteObject");this.onDeleteObject()},addRow:function(row){var $row=$(row).appendTo(this.$tbody),$deleteBtn=$row.find(".delete");if(this.settings.sortable){this.sorter.addItems($row)}this.addListener($deleteBtn,"click","deleteObject");this.totalObjects++;if(this.totalObjects==1){this.$noObjects.addClass("hidden");this.$table.show()}else{if(this.totalObjects==2){if(this.settings.sortable){this.$table.find(".move").removeClass("disabled")}if(!this.settings.allowDeleteAll){this.$deleteBtns.removeClass("disabled")}}}this.$deleteBtns=this.$deleteBtns.add($deleteBtn)},reorderObjects:function(){if(!this.settings.sortable){return false}var ids=[];for(var i=0;i<this.sorter.$items.length;i++){var id=$(this.sorter.$items[i]).attr(this.settings.idAttribute);ids.push(id)}var data={ids:JSON.stringify(ids)};Craft.postActionRequest(this.settings.reorderAction,data,$.proxy(function(response){if(response.success){Craft.cp.displayNotice(Craft.t(this.settings.reorderSuccessMessage))}else{Craft.cp.displayError(Craft.t(this.settings.reorderFailMessage))}},this))},deleteObject:function(event){if(!this.settings.allowDeleteAll&&this.totalObjects==1){return}var $row=$(event.target).closest("tr"),id=$row.attr(this.settings.idAttribute),name=$row.attr(this.settings.nameAttribute);if(this.confirmDeleteObject($row)){Craft.postActionRequest(this.settings.deleteAction,{id:id},$.proxy(function(response){if(response.success){$row.remove();this.totalObjects--;this.onDeleteObject();this.settings.onDeleteObject(id);Craft.cp.displayNotice(Craft.t(this.settings.deleteSuccessMessage,{name:name}))}else{Craft.cp.displayError(Craft.t(this.settings.deleteFailMessage,{name:name}))}},this))}},confirmDeleteObject:function($row){var name=$row.attr(this.settings.nameAttribute);return confirm(Craft.t(this.settings.confirmDeleteMessage,{name:name}))},onDeleteObject:function(){if(this.totalObjects==1){this.$table.find(".move").addClass("disabled");if(!this.settings.allowDeleteAll){this.$deleteBtns.addClass("disabled")}}else{if(this.totalObjects==0){this.$table.hide();$(this.settings.noObjectsSelector).removeClass("hidden")}}}},{defaults:{tableSelector:null,noObjectsSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:false,allowDeleteAll:true,reorderAction:null,deleteAction:null,reorderSuccessMessage:"New order saved.",reorderFailMessage:"Couldn’t save new order.",confirmDeleteMessage:"Are you sure you want to delete “{name}”?",deleteSuccessMessage:"“{name}” deleted.",deleteFailMessage:"Couldn’t delete “{name}”.",onDeleteObject:$.noop}});Craft.AssetIndex=Craft.BaseElementIndex.extend({$buttons:null,$uploadButton:null,$progressBar:null,$folders:null,$previouslySelectedFolder:null,uploader:null,promptHandler:null,progressBar:null,indexMode:false,initialSourceKey:null,isIndexBusy:false,_uploadTotalFiles:0,_uploadFileProgress:{},_uploadedFileIds:[],_selectedFileIds:[],_singleFileMenu:null,_multiFileMenu:null,_fileDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],init:function(elementType,$container,settings){this.base(elementType,$container,settings);if(this.settings.mode=="index"){this.indexMode=true;this.initIndexMode()}},initIndexMode:function(){var assetIndex=this;this._fileDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:0.5,filter:$.proxy(function(){return this.elementSelect.getSelectedItems()},this),helper:$.proxy(function($file){return this._getDragHelper($file)},this),dropTargets:$.proxy(function(){var targets=[];this.$sources.each(function(){targets.push($(this))});return targets},this),onDragStart:$.proxy(function(){this._tempExpandedFolders=[];this.$previouslySelectedFolder=this.$source.removeClass("sel")},this),onDropTargetChange:$.proxy(this,"_onDropTargetChange"),onDragStop:$.proxy(this,"_onFileDragStop")});this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:0.5,filter:$.proxy(function(){var $selected=this.sourceSelect.getSelectedItems(),draggees=[];for(var i=0;i<$selected.length;i++){var $source=$($selected[i]).parent();if($source.parents("ul").length>1){draggees.push($source[0])}}return $(draggees)},this),helper:$.proxy(function($folder){var $helper=$('<ul class="assets-fm-folderdrag" />').append($folder);$folder.removeClass("expanded");$helper.width(this.$sidebar[0].scrollWidth);return $helper},this),dropTargets:$.proxy(function(){var targets=[];this.$sources.each(function(){if(!$(this).is(assetIndex._folderDrag.$draggee)){targets.push($(this))}});return targets},this),onDragStart:$.proxy(function(){this._tempExpandedFolders=[];this._folderDrag.$draggee.filter(".expanded").removeClass("expanded").addClass("expanded-tmp")},this),onDropTargetChange:$.proxy(this,"_onDropTargetChange"),onDragStop:$.proxy(this,"_onFolderDragStop")});this.$sources.each(function(){assetIndex._createFolderContextMenu.apply(assetIndex,$(this));if($(this).parents("ul").length>1){assetIndex._folderDrag.addItems($(this).parent())}})},_onFileDragStop:function(){if(this._fileDrag.$activeDropTarget){this._fileDrag.$activeDropTarget.addClass("sel");var targetFolderId=this._getFolderIdFromSourceKey(this._fileDrag.$activeDropTarget.data("key"));var originalFileIds=[],newFileNames=[];for(var i=0;i<this._fileDrag.$draggee.length;i++){var originalFileId=this._fileDrag.$draggee[i].getAttribute("data-id"),fileName=$(this._fileDrag.$draggee[i]).find("[data-url]").attr("data-url").split("/").pop();originalFileIds.push(originalFileId);newFileNames.push(fileName)}if(originalFileIds.length){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(originalFileIds.length);this.progressBar.showProgressBar();var parameterArray=[];for(i=0;i<originalFileIds.length;i++){parameterArray.push({fileId:originalFileIds[i],folderId:targetFolderId,fileName:newFileNames[i]})}var onMoveFinish=$.proxy(function(responseArray){this.promptHandler.resetPrompts();for(var i=0;i<responseArray.length;i++){var data=responseArray[i];if(data.prompt){this.promptHandler.addPrompt(data)}if(data.error){alert(data.error)}}this.setIndexAvailable();this.progressBar.hideProgressBar();if(this.promptHandler.getPromptCount()){var promptCallback=$.proxy(function(returnData){var newParameterArray=[];for(var i=0;i<returnData.length;i++){if(returnData[i].choice=="cancel"){continue}for(var ii=0;ii<parameterArray.length;ii++){if(parameterArray[ii].fileName==returnData[i].fileName){parameterArray[ii].action=returnData[i].choice;newParameterArray.push(parameterArray[ii])}}}if(newParameterArray.length==0){this._selectSourceByFolderId(targetFolderId)}else{this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(this.promptHandler.getPromptCount());this.progressBar.showProgressBar();this._moveFile(newParameterArray,0,onMoveFinish)}},this);this._fileDrag.fadeOutHelpers();this.promptHandler.showBatchPrompts(promptCallback)}else{this._fileDrag.fadeOutHelpers();this._selectSourceByFolderId(targetFolderId)}},this);this._moveFile(parameterArray,0,onMoveFinish);return}}else{this._collapseExtraExpandedFolders()}this.$previouslySelectedFolder.addClass("sel");this._fileDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){this._folderDrag.$draggee.filter(".expanded-tmp").removeClass("expanded-tmp").addClass("expanded");if(this._folderDrag.$activeDropTarget&&this._folderDrag.$activeDropTarget.siblings("ul").find(">li").filter(this._folderDrag.$draggee).length==0){var targetFolderId=this._getFolderIdFromSourceKey(this._folderDrag.$activeDropTarget.data("key"));this._collapseExtraExpandedFolders(targetFolderId);var folderIds=[];for(var i=0;i<this._folderDrag.$draggee.length;i++){var $a=$("> a",this._folderDrag.$draggee[i]),folderId=this._getFolderIdFromSourceKey($a.data("key")),$source=this._getSourceByFolderId(folderId);if(this._getFolderIdFromSourceKey(this._getParentSource($source).data("key"))!=targetFolderId){folderIds.push(folderId)}}if(folderIds.length){folderIds.sort();folderIds.reverse();this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(folderIds.length);this.progressBar.showProgressBar();var responseArray=[];var parameterArray=[];for(var i=0;i<folderIds.length;i++){parameterArray.push({folderId:folderIds[i],parentId:targetFolderId})}this.requestId++;var fileMoveList=[];var folderDeleteList=[];var changedFolderIds={};var removeFromTree=[];var onMoveFinish=$.proxy(function(responseArray){this.promptHandler.resetPrompts();for(var i=0;i<responseArray.length;i++){var data=responseArray[i];if(data.success){if(data.transferList&&data.deleteList&&data.changedFolderIds){for(var ii=0;ii<data.transferList.length;ii++){fileMoveList.push(data.transferList[ii])}for(var ii=0;ii<data.deleteList.length;ii++){folderDeleteList.push(data.deleteList[ii])}for(var oldFolderId in data.changedFolderIds){changedFolderIds[oldFolderId]=data.changedFolderIds[oldFolderId]}removeFromTree.push(data.removeFromTree)}}if(data.prompt){this.promptHandler.addPrompt(data)}if(data.error){alert(data.error)}}if(this.promptHandler.getPromptCount()){var promptCallback=$.proxy(function(returnData){this.promptHandler.resetPrompts();this.setNewElementDataHtml("");var newParameterArray=[];for(var i=0;i<returnData.length;i++){if(returnData[i].choice=="cancel"){continue}parameterArray[0].action=returnData[i].choice;newParameterArray.push(parameterArray[0])}if(newParameterArray.length==0){$.proxy(this,"_performActualFolderMove",fileMoveList,folderDeleteList,changedFolderIds,removeFromTree)()}else{this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(this.promptHandler.getPromptCount());this.progressBar.showProgressBar();moveFolder(newParameterArray,0,onMoveFinish)}},this);this.promptHandler.showBatchPrompts(promptCallback);this.setIndexAvailable();this.progressBar.hideProgressBar()}else{$.proxy(this,"_performActualFolderMove",fileMoveList,folderDeleteList,changedFolderIds,removeFromTree,targetFolderId)()}},this);var moveFolder=$.proxy(function(parameterArray,parameterIndex,callback){if(parameterIndex==0){responseArray=[]}Craft.postActionRequest("assets/moveFolder",parameterArray[parameterIndex],$.proxy(function(data){parameterIndex++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();responseArray.push(data);if(parameterIndex>=parameterArray.length){callback(responseArray)}else{moveFolder(parameterArray,parameterIndex,callback)}},this))},this);moveFolder(parameterArray,0,onMoveFinish);return}}else{this._collapseExtraExpandedFolders()}this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(fileMoveList,folderDeleteList,changedFolderIds,removeFromTree,targetFolderId){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(1);this.progressBar.showProgressBar();var moveCallback=$.proxy(function(folderDeleteList,changedFolderIds,removeFromTree){var topFolderLi=$();var folderToMove=$();var topMovedFolderId=0;for(var previousFolderId in changedFolderIds){folderToMove=this._getSourceByFolderId(previousFolderId);folderToMove=folderToMove.attr("data-key","folder:"+changedFolderIds[previousFolderId].newId).data("key","folder:"+changedFolderIds[previousFolderId].newId).parent();if(topFolderLi.length==0||topFolderLi.parents().filter(folderToMove).length>0){topFolderLi=folderToMove;topFolderMovedId=changedFolderIds[previousFolderId].newId}}if(topFolderLi.length==0){this.setIndexAvailable();this.progressBar.hideProgressBar();this._folderDrag.returnHelpersToDraggees();return}var topFolder=topFolderLi.find(">a");var siblings=topFolderLi.siblings("ul, .toggle");var parentSource=this._getParentSource(topFolder);var newParent=this._getSourceByFolderId(targetFolderId);this._prepareParentForChildren(newParent);this._addSubfolder(newParent,topFolderLi);topFolder.after(siblings);this._cleanUpTree(parentSource);this.$sidebar.find("ul>ul, ul>.toggle").remove();for(var i=0;i<folderDeleteList.length;i++){Craft.postActionRequest("assets/deleteFolder",{folderId:folderDeleteList[i]})}this.setIndexAvailable();this.progressBar.hideProgressBar();this._folderDrag.returnHelpersToDraggees();this._selectSourceByFolderId(topFolderMovedId)},this);if(fileMoveList.length>0){this._moveFile(fileMoveList,0,$.proxy(function(){moveCallback(folderDeleteList,changedFolderIds,removeFromTree)},this))}else{moveCallback(folderDeleteList,changedFolderIds,removeFromTree)}},_getParentSource:function($source){if($source.parents("ul").length==1){return null}return $source.parent().parent().siblings("a")},_moveFile:function(parameterArray,parameterIndex,callback){if(parameterIndex==0){this.responseArray=[]}Craft.postActionRequest("assets/moveFile",parameterArray[parameterIndex],$.proxy(function(data){this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();this.responseArray.push(data);parameterIndex++;if(parameterIndex>=parameterArray.length){callback(this.responseArray)}else{this._moveFile(parameterArray,parameterIndex,callback)}},this))},_selectSourceByFolderId:function(targetFolderId){var targetSource=this._getSourceByFolderId(targetFolderId);var parentSources=targetSource.parent().parents("li");parentSources.each(function(){if(!$(this).hasClass("expanded")){$(this).find("> .toggle").click()}});this.selectSource(targetSource);this.updateElements()},onAfterHtmlInit:function(){if(!this.$buttons){this.$buttons=$('<div class="buttons"></div>').prependTo(this.$sidebar)}if(!this.$uploadButton){this.$uploadButton=$('<div class="assets-upload"></div>').prependTo(this.$buttons)}if(!this.$progressBar){this.$progressBar=$('<div class="assets-uploadprogress hidden"><div class="assets-progressbar"><div class="assets-pb-bar"></div></div></div>').appendTo(this.$main)}this.promptHandler=new Craft.PromptHandler();this.progressBar=new Craft.ProgressBar(this.$progressBar);var uploaderCallbacks={onSubmit:$.proxy(this,"_onUploadSubmit"),onProgress:$.proxy(this,"_onUploadProgress"),onComplete:$.proxy(this,"_onUploadComplete")};this.uploader=new Craft.Uploader(this.$uploadButton,uploaderCallbacks);this.base()},onSelectSource:function(sourceKey){this.uploader.setParams({folderId:this._getFolderIdFromSourceKey(sourceKey)});this.base(sourceKey)},_getFolderIdFromSourceKey:function(sourceKey){return sourceKey.split(":")[1]},_onUploadSubmit:function(id){if(!this.uploader.getInProgress()){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.showProgressBar();this._uploadFileProgress={};this._uploadedFileIds=[];this._uploadTotalFiles=1}else{this._uploadTotalFiles++}this._uploadFileProgress[id]=0},_onUploadProgress:function(id,fileName,loaded,total){this._uploadFileProgress[id]=loaded/total;this._updateUploadProgress()},_updateUploadProgress:function(){var totalPercent=0;for(var id in this._uploadFileProgress){totalPercent+=this._uploadFileProgress[id]}var width=Math.round(100*totalPercent/this._uploadTotalFiles)+"%";this.progressBar.setProgressPercentage(width)},_onUploadComplete:function(id,fileName,response){this._uploadFileProgress[id]=1;this._updateUploadProgress();if(response.success||response.prompt){this._uploadedFileIds.push(response.fileId);if(response.prompt){this.promptHandler.addPrompt(response)}}if(!this.uploader.getInProgress()){this.setIndexAvailable();this.progressBar.hideProgressBar();if(this.promptHandler.getPromptCount()){this.promptHandler.showBatchPrompts($.proxy(this,"_uploadFollowup"))}else{this.updateElements()}}},_uploadFollowup:function(returnData){this.setIndexBusy();this.progressBar.resetProgressBar();this.promptHandler.resetPrompts();var finalCallback=$.proxy(function(){this.setIndexBusy();this.progressBar.hideProgressBar();this.updateElements()},this);this.progressBar.setItemCount(returnData.length);var doFollowup=$.proxy(function(parameterArray,parameterIndex,callback){var postData={additionalInfo:parameterArray[parameterIndex].additionalInfo,fileName:parameterArray[parameterIndex].fileName,userResponse:parameterArray[parameterIndex].choice};Craft.postActionRequest("assets/uploadFile",postData,$.proxy(function(data){if(typeof data.fileId!="undefined"){this._uploadedFileIds.push(data.fileId)}parameterIndex++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();if(parameterIndex==parameterArray.length){callback()}else{doFollowup(parameterArray,parameterIndex,callback)}},this))},this);doFollowup(returnData,0,finalCallback)},onUpdateElements:function(append){this.base(append);if(this.indexMode){$elements=this.$elementContainer.children(":not(.disabled)");this._initElementSelect($elements);this._attachElementEvents($elements);this._initElementDragger($elements)}if(this._uploadedFileIds.length){var item=null;for(var i=0;i<this._uploadedFileIds.length;i++){item=this.$main.find("[data-id="+this._uploadedFileIds[i]+"]:first");this.elementSelect.selectItem(item)}this._uploadedFileIds=[]}},_initElementSelect:function($children){if(typeof this.elementSelect=="object"&&this.elementSelect!=null){this.elementSelect.destroy();delete this.elementSelect}var elementSelect=new Garnish.Select(this.$elementContainer,$children,{multi:true,vertical:(this.getState("view")=="table"),waitForDblClick:true,onSelectionChange:$.proxy(this,"_onElementSelectionChange")});this.setElementSelect(elementSelect)},_onElementSelectionChange:function(){this._enableElementContextMenu();var selected=this.elementSelect.getSelectedItems();this._selectedFileIds=[];for(var i=0;i<selected.length;i++){this._selectedFileIds[i]=$(selected[i]).attr("data-id")}},_attachElementEvents:function($elements){this.removeListener($elements,"dlbclick");this.addListener($elements,"dblclick",$.proxy(this,"_editProperties"));this._destroyElementContextMenus();this._createElementContextMenus($elements)},_initElementDragger:function($elements){this._fileDrag.removeAllItems();this._fileDrag.addItems($elements)},_editProperties:function(event){var $target=$(event.currentTarget);if(this.getState("view")=="table"){$target=$target.find(".element")}if(!$target.data("ElementEditor")){var settings={elementId:$target.attr("data-id"),$trigger:$target,loadContentAction:"assets/editFileContent",saveContentAction:"assets/saveFileContent"};$target.data("ElementEditor",new Craft.ElementEditor(settings))}$target.data("ElementEditor").show()},_createElementContextMenus:function($elements){var settings={menuClass:"menu assets-contextmenu"};var menuOptions=[{label:Craft.t("View file"),onClick:$.proxy(this,"_viewFile")}];menuOptions.push({label:Craft.t("Edit properties"),onClick:$.proxy(this,"_showProperties")});menuOptions.push({label:Craft.t("Rename file"),onClick:$.proxy(this,"_renameFile")});menuOptions.push("-");menuOptions.push({label:Craft.t("Delete file"),onClick:$.proxy(this,"_deleteFile")});this._singleFileMenu=new Garnish.ContextMenu($elements,menuOptions,settings);menuOptions=[{label:Craft.t("Delete"),onClick:$.proxy(this,"_deleteFiles")}];this._multiFileMenu=new Garnish.ContextMenu($elements,menuOptions,settings);this._enableElementContextMenu()},_destroyElementContextMenus:function(){if(this._singleFileMenu!==null){this._singleFileMenu.destroy()}if(this._multiFileMenu!==null){this._singleFileMenu.destroy()}},_enableElementContextMenu:function(){this._multiFileMenu.disable();this._singleFileMenu.disable();if(this.elementSelect.getTotalSelected()==1){this._singleFileMenu.enable()}else{if(this.elementSelect.getTotalSelected()>1){this._multiFileMenu.enable()}}},_showProperties:function(event){$(event.currentTarget).dblclick()},_viewFile:function(event){window.open($(event.currentTarget).find("[data-url]").attr("data-url"))},_renameFile:function(event){var $target=$(event.currentTarget);var fileId=$target.attr("data-id"),oldName=$target.find("[data-url]").attr("data-url").split("/").pop(),newName=prompt(Craft.t("Rename file"),oldName);if(newName&&newName!=oldName){this.setIndexBusy();var postData={fileId:fileId,folderId:this._getFolderIdFromSourceKey(this.$source.data("key")),fileName:newName};var handleRename=function(data,textStatus){this.setIndexAvailable();this.promptHandler.resetPrompts();if(textStatus=="success"){if(data.prompt){this.promptHandler.addPrompt(data);var callback=$.proxy(function(choice){choice=choice[0].choice;if(choice!="cancel"){postData.action=choice;Craft.postActionRequest("assets/moveFile",postData,$.proxy(handleRename,this))}},this);this.promptHandler.showBatchPrompts(callback)}if(data.success){this.updateElements()}if(data.error){alert(data.error)}}};Craft.postActionRequest("assets/moveFile",postData,$.proxy(handleRename,this))}},_deleteFile:function(event){var $target=$(event.currentTarget);var fileId=$target.attr("data-id");var fileName=$target.attr("data-label");if(confirm(Craft.t("Are you sure you want to delete “{file}”?",{file:fileName}))){if($target.data("AssetEditor")){$target.data("AssetEditor").removeHud()}this.setIndexBusy();Craft.postActionRequest("assets/deleteFile",{fileId:fileId},$.proxy(function(data,textStatus){this.setIndexAvailable();if(textStatus=="success"){if(data.error){alert(data.error)}this.updateElements()}},this))}},_deleteFiles:function(){if(confirm(Craft.t("Are you sure you want to delete these {number} files?",{number:this.elementSelect.getTotalSelected()}))){this.setIndexBusy();var postData={};for(var i=0;i<this._selectedFileIds.length;i++){postData["fileId["+i+"]"]=this._selectedFileIds[i]}Craft.postActionRequest("assets/deleteFile",postData,$.proxy(function(data,textStatus){this.setIndexAvailable();if(textStatus=="success"){if(data.error){alert(data.error)}this.updateElements()}},this))}},_getDragHelper:function($element){var currentView=this.getState("view");switch(currentView){case"table":var $container=$('<div class="assets-listview assets-lv-drag" />'),$table=$('<table cellpadding="0" cellspacing="0" border="0" />').appendTo($container),$tbody=$("<tbody />").appendTo($table);$table.width(this.$table.width());$tbody.append($element);return $container;case"thumbs":return $('<ul class="thumbsview assets-tv-drag" />').append($element.removeClass("sel"))}return $()},_onDropTargetChange:function($dropTarget){clearTimeout(this._expandDropTargetFolderTimeout);if($dropTarget){var folderId=this._getFolderIdFromSourceKey($dropTarget.data("key"));if(folderId){this.dropTargetFolder=this._getSourceByFolderId(folderId);if(this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)){this._expandDropTargetFolderTimeout=setTimeout($.proxy(this,"_expandFolder"),500)}}else{this.dropTargetFolder=null}}},_collapseExtraExpandedFolders:function(dropTargetFolderId){clearTimeout(this._expandDropTargetFolderTimeout);if(dropTargetFolderId){var excluded=this._getSourceByFolderId(dropTargetFolderId).parents("li").find(">a")}for(var i=this._tempExpandedFolders.length-1;i>=0;i--){var source=this._tempExpandedFolders[i];if(!dropTargetFolderId||excluded.filter('[data-key="'+source.data("key")+'"]').length==0){this._collapseFolder(source);this._tempExpandedFolders.splice(i,1)}}},_getSourceByFolderId:function(folderId){return this.$sources.filter('[data-key="folder:'+folderId+'"]')},_hasSubfolders:function(source){return source.siblings("ul").find("li").length},_isExpanded:function(source){return source.parent("li").hasClass("expanded")},_expandFolder:function(){this._collapseExtraExpandedFolders(this._getFolderIdFromSourceKey(this.dropTargetFolder.data("key")));this.dropTargetFolder.parent().find("> .toggle").click();this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(source){var li=source.parent();if(li.hasClass("expanded")){li.find("> .toggle").click()}},_createFolderContextMenu:function(element){element=$(element);var menuOptions=[{label:Craft.t("New subfolder"),onClick:$.proxy(this,"_createSubfolder",element)}];if(element.parents("ul").length>1){menuOptions.push({label:Craft.t("Rename folder"),onClick:$.proxy(this,"_renameFolder",element)});menuOptions.push({label:Craft.t("Delete folder"),onClick:$.proxy(this,"_deleteFolder",element)})}new Garnish.ContextMenu(element,menuOptions,{menuClass:"menu assets-contextmenu"})},_createSubfolder:function(parentFolder){var subfolderName=prompt(Craft.t("Enter the name of the folder"));if(subfolderName){var params={parentId:this._getFolderIdFromSourceKey(parentFolder.data("key")),folderName:subfolderName};this.setIndexBusy();Craft.postActionRequest("assets/createFolder",params,$.proxy(function(data){this.setIndexAvailable();if(data.success){this._prepareParentForChildren(parentFolder);var subFolder=$('<li><a data-key="folder:'+data.folderId+'">'+data.folderName+"</a></li>");var $a=subFolder.find("a");this._addSubfolder(parentFolder,subFolder);this._createFolderContextMenu($a);this.sourceSelect.addItems($a);this._folderDrag.addItems($a.parent());this.$sources=this.$sources.add($a)}if(data.error){alert(data.error)}},this))}},_deleteFolder:function(targetFolder){if(confirm(Craft.t("Really delete folder “{folder}”?",{folder:$.trim(targetFolder.text())}))){var params={folderId:this._getFolderIdFromSourceKey(targetFolder.data("key"))};this.setIndexBusy();Craft.postActionRequest("assets/deleteFolder",params,$.proxy(function(data){this.setIndexAvailable();if(data.success){var parentFolder=this._getParentSource(targetFolder);this.$sources=this.$sources.not(targetFolder);this.sourceSelect.removeItems(targetFolder);targetFolder.parent().remove();this._cleanUpTree(parentFolder)}if(data.error){alert(data.error)}},this))}},_renameFolder:function(targetFolder){var oldName=$.trim(targetFolder.text()),newName=prompt(Craft.t("Rename folder"),oldName);if(newName&&newName!=oldName){var params={folderId:this._getFolderIdFromSourceKey(targetFolder.data("key")),newName:newName};this.setIndexBusy();Craft.postActionRequest("assets/renameFolder",params,$.proxy(function(data){this.setIndexAvailable();if(data.success){targetFolder.text(data.newName)}if(data.error){alert(data.error)}},this),"json")}},_prepareParentForChildren:function(parentFolder){if(!this._hasSubfolders(parentFolder)){parentFolder.parent().addClass("expanded").append('<div class="toggle"></div><ul></ul>');this.addListener(parentFolder.siblings(".toggle"),"click",function(ev){$(ev.currentTarget).parent().toggleClass("expanded")})}},_addSubfolder:function(parentFolder,subFolder){var existingChildren=parentFolder.siblings("ul").find("li");var folderInserted=false;existingChildren.each(function(){if(!folderInserted&&$.trim($(this).text())>$.trim(subFolder.text())){$(this).before(subFolder);folderInserted=true}});if(!folderInserted){parentFolder.siblings("ul").append(subFolder)}},_cleanUpTree:function(parentFolder){if(parentFolder!==null&&parentFolder.siblings("ul").find("li").length==0){parentFolder.siblings("ul").remove();parentFolder.siblings(".toggle").remove();parentFolder.parent().removeClass("expanded")}}});Craft.registerElementIndexClass("Asset",Craft.AssetIndex);Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,init:function(id,name,elementType,sources,criteria,limit){this.base(id,name,elementType,sources,criteria,limit);this._attachHUDEvents()},selectElements:function(elements){this.base(elements);this._attachHUDEvents()},_attachHUDEvents:function(){this.removeListener(this.$elements,"dlbclick");this.addListener(this.$elements,"dblclick",$.proxy(this,"_editProperties"))},_editProperties:function(event){var $target=$(event.currentTarget);if(!$target.data("ElementEditor")){var settings={elementId:$target.attr("data-id"),$trigger:$target,loadContentAction:"assets/editFileContent",saveContentAction:"assets/saveFileContent"};$target.data("ElementEditor",new Craft.ElementEditor(settings))}$target.data("ElementEditor").show()}});Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({init:function(elementType,settings){this.base(elementType,settings)}});Craft.registerElementSelectorModalClass("Asset",Craft.AssetSelectorModal);Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(table,settings){this.$table=$(table);var $rows=this.$table.children("tbody").children(":not(.filler)");settings=$.extend({},Craft.DataTableSorter.defaults,settings);settings.container=this.$table.children("tbody");settings.helper=$.proxy(this,"getHelper");settings.caboose="<tr/>";settings.axis=Garnish.Y_AXIS;this.base($rows,settings)},getHelper:function($helperRow){var $helper=$('<div class="'+this.settings.helperClass+'"/>').appendTo(Garnish.$bod),$table=$("<table/>").appendTo($helper),$tbody=$("<tbody/>").appendTo($table);$helperRow.appendTo($tbody);$table.width(this.$table.width());$table.prop("className",this.$table.prop("className"));var $firstRow=this.$table.find("tr:first"),$cells=$firstRow.children(),$helperCells=$helperRow.children();for(var i=0;i<$helperCells.length;i++){$($helperCells[i]).width($($cells[i]).width())}return $helper}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}});Craft.EditableTable=Garnish.Base.extend({id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,init:function(id,baseName,columns,settings){this.id=id;this.baseName=baseName;this.columns=columns;this.setSettings(settings,Craft.EditableTable.defaults);this.$table=$("#"+id);this.$tbody=this.$table.children("tbody");this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:"editabletablesorthelper"});var $rows=this.$tbody.children();for(var i=0;i<$rows.length;i++){new Craft.EditableTable.Row(this,$rows[i])}this.$addRowBtn=this.$table.next(".add");this.addListener(this.$addRowBtn,"activate","addRow")},addRow:function(){var rowId=this.settings.rowIdPrefix+(this.biggestId+1),rowHtml=Craft.EditableTable.getRowHtml(rowId,this.columns,this.baseName,{}),$tr=$(rowHtml).appendTo(this.$tbody);new Craft.EditableTable.Row(this,$tr);this.sorter.addItems($tr);$tr.find("input,textarea,select").first().focus();this.settings.onAddRow($tr)}},{textualColTypes:["singleline","multiline","number"],defaults:{rowIdPrefix:"",onAddRow:$.noop,onDeleteRow:$.noop},getRowHtml:function(rowId,columns,baseName,values){var rowHtml='<tr data-id="'+rowId+'">';for(var colId in columns){var col=columns[colId],name=baseName+"["+rowId+"]["+colId+"]",value=(typeof values[colId]!="undefined"?values[colId]:""),textual=Craft.inArray(col.type,Craft.EditableTable.textualColTypes);rowHtml+='<td class="'+(textual?"textual":"")+" "+(typeof col["class"]!="undefined"?col["class"]:"")+'"'+(typeof col.width!="undefined"?' width="'+col.width+'"':"")+">";switch(col.type){case"select":rowHtml+='<div class="select small"><select name="'+name+'">';for(var optionValue in col.options){rowHtml+='<option value="'+optionValue+'"'+(optionValue==value?" selected":"")+">"+col.options[optionValue]+"</option>"}rowHtml+="</select></div>";break;case"checkbox":rowHtml+='<input type="hidden" name="'+name+'"><input type="checkbox" name="'+name+'" value="1"'+(value?" checked":"")+">";break;default:rowHtml+='<textarea name="'+name+'" rows="1">'+value+"</textarea>"}rowHtml+="</td>"}rowHtml+='<td class="thin action"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin action"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>';return rowHtml}});Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,$textareas:null,$deleteBtn:null,init:function(table,tr){this.table=table;this.$tr=$(tr);this.$tds=this.$tr.children();var id=parseInt(this.$tr.attr("data-id").substr(this.table.settings.rowIdPrefix.length));if(id>this.table.biggestId){this.table.biggestId=id}this.$textareas=$();this.niceTexts=[];var textareasByColId={};var i=0;for(var colId in this.table.columns){var col=this.table.columns[colId];if(Craft.inArray(col.type,Craft.EditableTable.textualColTypes)){$textarea=$("textarea",this.$tds[i]);this.$textareas=this.$textareas.add($textarea);this.addListener($textarea,"focus","onTextareaFocus");this.addListener($textarea,"mousedown","ignoreNextTextareaFocus");this.niceTexts.push(new Garnish.NiceText($textarea,{onHeightChange:$.proxy(this,"onTextareaHeightChange")}));if(col.type=="singleline"||col.type=="number"){this.addListener($textarea,"keypress",{type:col.type},"validateKeypress")}textareasByColId[colId]=$textarea}i++}this.onTextareaHeightChange();for(var colId in this.table.columns){var col=this.table.columns[colId];if(col.autopopulate&&typeof textareasByColId[col.autopopulate]!="undefined"&&!textareasByColId[colId].val()){if(col.autopopulate=="handle"){new Craft.HandleGenerator(textareasByColId[colId],textareasByColId[col.autopopulate])}else{new Craft.BaseInputGenerator(textareasByColId[colId],textareasByColId[col.autopopulate])}}}var $deleteBtn=this.$tr.children().last().find(".delete");this.addListener($deleteBtn,"click","deleteRow")},onTextareaFocus:function(ev){var $textarea=$(ev.currentTarget);if($textarea.data("ignoreNextFocus")){$textarea.data("ignoreNextFocus",false);return}setTimeout(function(){var val=$textarea.val();if(typeof $textarea[0].setSelectionRange!="undefined"){var length=val.length*2;$textarea[0].setSelectionRange(0,length)}else{$textarea.val(val)}},0)},ignoreNextTextareaFocus:function(ev){$.data(ev.currentTarget,"ignoreNextFocus",true)},validateKeypress:function(ev){var keyCode=ev.keyCode?ev.keyCode:ev.charCode;if(!ev.metaKey&&!ev.ctrlKey&&((keyCode==Garnish.RETURN_KEY)||(ev.data.type=="number"&&!Craft.inArray(keyCode,Craft.EditableTable.Row.numericKeyCodes)))){ev.preventDefault()}},onTextareaHeightChange:function(){var tallestTextareaHeight=-1;for(var i=0;i<this.niceTexts.length;i++){if(this.niceTexts[i].height>tallestTextareaHeight){tallestTextareaHeight=this.niceTexts[i].height}}this.$textareas.css("min-height",tallestTextareaHeight)},deleteRow:function(){this.table.sorter.removeItems(this.$tr);this.$tr.remove();this.table.settings.onDeleteRow(this.$tr)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]});var x;Craft.ElementEditor=Garnish.Base.extend({hud:null,elementId:0,requestId:0,$trigger:null,$spinner:null,init:function(settings){this.setSettings(settings,Craft.ElementEditor.defaults);this.elementId=this.settings.elementId;this.$trigger=this.settings.$trigger},show:function(){var params={requestId:++this.requestId,elementId:this.elementId};this._showSpinner();Craft.postActionRequest(this.settings.loadContentAction,params,$.proxy(function(data,textStatus){this._hideSpinner();if(data.requestId!=this.requestId){return}$hudHtml=$("<div/>").html((data.headHtml?data.headHtml:"")+(data.bodyHtml?data.bodyHtml:"")+(data.footHtml?data.footHtml:""));this.hud=new Garnish.HUD(this.$trigger,$hudHtml,{hudClass:"hud contenthud",triggerSpacing:10,tipWidth:30,closeOtherHUDs:false});Craft.initUiElements($hudHtml);this.addListener($hudHtml.find("form"),"submit",$.proxy(this,"_saveElementDetails"));this.addListener($hudHtml.find(".btn.submit"),"click",function(ev){$(ev.currentTarget).parents("form").submit()});this.addListener($hudHtml.find(".btn.cancel"),"click",$.proxy(this,"removeHud"))},this))},_saveElementDetails:function(event){event.preventDefault();this.hud.$body.find(".spinner").removeClass("hidden");$form=$(event.currentTarget);var params=$form.serialize();Craft.postActionRequest(this.settings.saveContentAction,params,$.proxy(function(response,textStatus){if(response.success){this.$trigger.find(".label").text(response.title);this.hud.$body.find(".spinner").hide();this.removeHud()}else{this.hud.$body.find(".spinner").addClass("hidden");Garnish.shake(this.hud.$hud)}},this))},_showSpinner:function(){this.removeHud();this.$trigger.find(".delete").addClass("hidden");if(this.$trigger.hasClass("removable")){this.$trigger.removeClass("removable").data("elementInputField",true)}this.$trigger.find(".label").css("padding-right","20px");this.$trigger.find(".label").after('<div class="spinner element-spinner" style="position: absolute; right: 2px; bottom: -1px;"></div>')},_hideSpinner:function(){this.$trigger.find(".delete").removeClass("hidden");this.$trigger.find(".label").removeClass("spinner element-spinner inline").html(this.$trigger.find(".label nobr").html());if(this.$trigger.data("elementInputField")){this.$trigger.addClass("removable")}this.$trigger.find(".label").css("padding-right","0");this.$trigger.find(".label").siblings(".spinner").remove()},removeHud:function(){if(this.hud!==null){this.hud.hide();delete this.hud}}},{defaults:{elementId:null,$trigger:null,loadContentAction:null,saveContentAction:null}});Craft.EntryUrlFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(sourceVal){sourceVal=sourceVal.replace("/<(.*?)>/g","");sourceVal=sourceVal.toLowerCase();sourceVal=Craft.asciiString(sourceVal);sourceVal=sourceVal.replace(/^[^a-z]+/,"");sourceVal=sourceVal.replace(/[^a-z0-9]+$/,"");var words=Craft.filterArray(sourceVal.split(/[^a-z0-9]+/));if(words.length){return words.join("-")+"/{slug}"}return""}});Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(container,settings){this.$container=$(container);this.setSettings(settings,Craft.FieldLayoutDesigner.defaults);this.$tabContainer=this.$container.children(".fld-tabs");this.$unusedFieldContainer=this.$container.children(".unusedfields");this.$newTabBtn=$("#newtabbtn");this.$allFields=this.$unusedFieldContainer.find(".fld-field");this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings);this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);var $tabs=this.$tabContainer.children();for(var i=0;i<$tabs.length;i++){this.initTab($($tabs[i]))}this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this);if(this.settings.customizableTabs){this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this);this.addListener(this.$newTabBtn,"activate","addTab")}},initTab:function($tab){if(this.settings.customizableTabs){var $editBtn=$tab.find(".tabs .settings"),$menu=$('<div class="menu" data-align="center"/>').insertAfter($editBtn),$ul=$("<ul/>").appendTo($menu);$('<li><a data-action="rename">'+Craft.t("Rename")+"</a></li>").appendTo($ul);$('<li><a data-action="delete">'+Craft.t("Delete")+"</a></li>").appendTo($ul);new Garnish.MenuBtn($editBtn,{onOptionSelect:$.proxy(this,"onTabOptionSelect")})}var $fields=$tab.children(".fld-tabcontent").children();for(var i=0;i<$fields.length;i++){this.initField($($fields[i]))}},initField:function($field){var $editBtn=$field.find(".settings"),$menu=$('<div class="menu" data-align="center"/>').insertAfter($editBtn),$ul=$("<ul/>").appendTo($menu);if($field.hasClass("fld-required")){$('<li><a data-action="toggle-required">'+Craft.t("Make not required")+"</a></li>").appendTo($ul)}else{$('<li><a data-action="toggle-required">'+Craft.t("Make required")+"</a></li>").appendTo($ul)}$('<li><a data-action="remove">'+Craft.t("Remove")+"</a></li>").appendTo($ul);new Garnish.MenuBtn($editBtn,{onOptionSelect:$.proxy(this,"onFieldOptionSelect")})},onTabOptionSelect:function(option){if(!this.settings.customizableTabs){return}var $option=$(option),$tab=$option.data("menu").$trigger.parent().parent().parent(),action=$option.data("action");switch(action){case"rename":this.renameTab($tab);break;case"delete":this.deleteTab($tab);break}},onFieldOptionSelect:function(option){var $option=$(option),$field=$option.data("menu").$trigger.parent(),action=$option.data("action");switch(action){case"toggle-required":this.toggleRequiredField($field,$option);break;case"remove":this.removeField($field);break}},renameTab:function($tab){if(!this.settings.customizableTabs){return}var $labelSpan=$tab.find(".tabs .tab span"),oldName=$labelSpan.text(),newName=prompt(Craft.t("Give your tab a name."),oldName);if(newName&&newName!=oldName){$labelSpan.text(newName);$tab.find(".id-input").attr("name","fieldLayout["+encodeURIComponent(newName)+"][]")}},deleteTab:function($tab){if(!this.settings.customizableTabs){return}var $fields=$tab.find(".fld-field");for(var i=0;i<$fields.length;i++){var fieldId=$($fields[i]).attr("data-id");this.removeFieldById(fieldId)}this.tabGrid.removeItems($tab);this.tabDrag.removeItems($tab);$tab.remove()},toggleRequiredField:function($field,$option){if($field.hasClass("fld-required")){$field.removeClass("fld-required");$field.find(".required-input").remove();setTimeout(function(){$option.text(Craft.t("Make required"))},500)}else{$field.addClass("fld-required");$('<input class="required-input" type="hidden" name="requiredFields[]" value="'+$field.data("id")+'">').appendTo($field);setTimeout(function(){$option.text(Craft.t("Make not required"))},500)}},removeField:function($field){var fieldId=$field.attr("data-id");$field.remove();this.removeFieldById(fieldId);this.tabGrid.refreshCols()},removeFieldById:function(fieldId){var $field=this.$allFields.filter("[data-id="+fieldId+"]:first"),$group=$field.closest(".fld-tab");$field.removeClass("hidden");if($group.hasClass("hidden")){$group.removeClass("hidden");this.unusedFieldGrid.addItems($group);if(this.settings.customizableTabs){this.tabDrag.addItems($group)}}else{this.unusedFieldGrid.refreshCols()}},addTab:function(){if(!this.settings.customizableTabs){return}var $tab=$('<div class="fld-tab"><div class="tabs"><div class="tab sel draggable"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class="settings icon" title="'+Craft.t("Rename")+'"></a></div></div><div class="fld-tabcontent"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems($tab);this.tabDrag.addItems($tab);this.initTab($tab)}},{gridSettings:{minColWidth:240,percentageWidths:false,fillMode:"grid",snapToGrid:30},defaults:{customizableTabs:true}});Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:false,$caboose:null,draggingUnusedItem:false,addToTabGrid:false,init:function(designer,settings){this.designer=designer;var $items=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base($items,settings)},onDragStart:function(){this.base();this.draggingUnusedItem=this.$draggee.hasClass("unused");this.$insertion=this.getInsertion();this.addCaboose();this.$items=$().add(this.$items.add(this.$caboose));if(this.addToTabGrid){this.designer.tabGrid.addItems(this.$caboose)}if(this.draggingUnusedItem){this.showingInsertion=false}else{this.$insertion.insertBefore(this.$draggee);this.$draggee.detach();this.$items=$().add(this.$items.not(this.$draggee).add(this.$insertion));this.showingInsertion=true;if(this.addToTabGrid){this.designer.tabGrid.removeItems(this.$draggee);this.designer.tabGrid.addItems(this.$insertion)}}this.setMidpoints()},addCaboose:$.noop,getItemContainer:$.noop,isItemInTabContainer:function($item){return(this.getItemContainer($item)[0]==this.designer.$tabContainer[0])},setMidpoints:function(){for(var i=0;i<this.$items.length;i++){var $item=$(this.$items[i]);if(!this.isItemInTabContainer($item)){continue}var offset=$item.offset();$item.data("midpoint",{left:offset.left+$item.outerWidth()/2,top:offset.top+$item.outerHeight()/2})}},onDrag:function(){if(this.draggingUnusedItem&&!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)){if(this.showingInsertion){this.$insertion.remove();this.$items=$().add(this.$items.not(this.$insertion));this.showingInsertion=false;if(this.addToTabGrid){this.designer.tabGrid.removeItems(this.$insertion)}else{this.designer.tabGrid.refreshCols()}this.setMidpoints()}}else{this.onDrag._closestItem=this.getClosestItem();if(this.onDrag._closestItem!=this.$insertion[0]){if(this.showingInsertion&&($.inArray(this.$insertion[0],this.$items)<$.inArray(this.onDrag._closestItem,this.$items))&&($.inArray(this.onDrag._closestItem,this.$caboose)==-1)){this.$insertion.insertAfter(this.onDrag._closestItem)}else{this.$insertion.insertBefore(this.onDrag._closestItem)}this.$items=$().add(this.$items.add(this.$insertion));this.showingInsertion=true;if(this.addToTabGrid){this.designer.tabGrid.addItems(this.$insertion)}else{this.designer.tabGrid.refreshCols()}this.setMidpoints()}}this.base()},getClosestItem:function(){this.getClosestItem._closestItem=null;this.getClosestItem._closestItemMouseDiff=null;for(this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++){this.getClosestItem._$item=$(this.$items[this.getClosestItem._i]);if(!this.isItemInTabContainer(this.getClosestItem._$item)){continue}this.getClosestItem._midpoint=this.getClosestItem._$item.data("midpoint");this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY);if(this.getClosestItem._closestItem===null||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff){this.getClosestItem._closestItem=this.getClosestItem._$item[0];this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff}}return this.getClosestItem._closestItem},onDragStop:function(){if(this.showingInsertion){this.$insertion.replaceWith(this.$draggee);this.$items=$().add(this.$items.not(this.$insertion).add(this.$draggee));if(this.addToTabGrid){this.designer.tabGrid.removeItems(this.$insertion);this.designer.tabGrid.addItems(this.$draggee)}}this.$items=this.$items.not(this.$caboose);this.$caboose.remove();if(this.addToTabGrid){this.designer.tabGrid.removeItems(this.$caboose)}this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"});this.designer.tabGrid.refreshCols();this.designer.unusedFieldGrid.refreshCols();this.returnHelpersToDraggees();this.base()}});Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab",addToTabGrid:true,init:function(designer){var settings={handle:".tab"};this.base(designer,settings)},addCaboose:function(){this.$caboose=$('<div class="fld-tab fld-tab-caboose"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var $tab=this.$draggee.find(".tab");return $('<div class="fld-tab fld-insertion" style="height: '+this.$draggee.height()+'px;"><div class="tabs"><div class="tab sel draggable" style="width: '+$tab.width()+"px; height: "+$tab.height()+'px;"></div></div><div class="fld-tabcontent" style="height: '+this.$draggee.find(".fld-tabcontent").height()+'px;"></div></div>')},getItemContainer:function($item){return $item.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var $tab=this.$draggee.clone().removeClass("unused"),tabName=$tab.find(".tab span").text();$tab.find(".fld-field").removeClass("unused");$tab.find(".tabs .tab").append('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');var $fields=$tab.find(".fld-field"),$hiddenFields=$fields.filter(".hidden").remove();$fields=$fields.not($hiddenFields);$fields.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');for(var i=0;i<$fields.length;i++){var $field=$($fields[i]);$field.append('<input class="id-input" type="hidden" name="fieldLayout['+encodeURIComponent(tabName)+'][]" value="'+$field.data("id")+'">')}this.designer.fieldDrag.addItems($fields);this.designer.initTab($tab);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");this.$draggee.find(".fld-field").addClass("hidden");this.$draggee=$tab;this.addItems($tab);this.designer.tabGrid.addItems($tab);this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}});Craft.FieldLayoutDesigner.FieldDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab .fld-field",addCaboose:function(){this.$caboose=$();var $fieldContainers=this.designer.$tabContainer.children().children(".fld-tabcontent");for(var i=0;i<$fieldContainers.length;i++){var $caboose=$('<div class="fld-tab fld-tab-caboose"/>').appendTo($fieldContainers[i]);this.$caboose=this.$caboose.add($caboose)}},getInsertion:function(){return $('<div class="fld-field fld-insertion" style="height: '+this.$draggee.height()+'px;"/>')},getItemContainer:function($item){return $item.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var $field=this.$draggee.clone().removeClass("unused");$field.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');this.designer.initField($field);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");if(this.$draggee.siblings(":not(.hidden)").length==0){var $group=this.$draggee.parent().parent();$group.addClass("hidden");this.designer.unusedFieldGrid.removeItems($group)}this.$draggee=$field;this.addItems($field)}if(this.showingInsertion){var tabName=this.$insertion.parent().parent().find(".tab span").text(),inputName="fieldLayout["+encodeURIComponent(tabName)+"][]";if(this.draggingUnusedItem){this.$draggee.append('<input class="id-input" type="hidden" name="'+inputName+'" value="'+this.$draggee.data("id")+'">')}else{this.$draggee.find(".id-input").attr("name",inputName)}}this.base()}});Craft.FieldToggle=Garnish.Base.extend({$toggle:null,reverse:null,targetPrefix:null,_$target:null,type:null,init:function(toggle){this.$toggle=$(toggle);if(this.$toggle.data("fieldtoggle")){Garnish.log("Double-instantiating a field toggle on an element");this.$toggle.data("fieldtoggle").destroy()}this.$toggle.data("fieldtoggle",this);this.type=this.getType();this.reverse=!!this.$toggle.attr("data-reverse-toggle");if(this.type=="select"){this.targetPrefix=(this.$toggle.attr("data-target-prefix")||"");this.findTarget()}if(this.type=="link"){this.addListener(this.$toggle,"click","onToggleChange")}else{this.addListener(this.$toggle,"change","onToggleChange")}},getType:function(){if(this.$toggle.prop("nodeName")=="INPUT"&&this.$toggle.attr("type").toLowerCase()=="checkbox"){return"checkbox"}else{if(this.$toggle.prop("nodeName")=="SELECT"){return"select"}else{if(this.$toggle.prop("nodeName")=="A"){return"link"}}}},getTarget:function(){if(!this._$target){this.findTarget()}return this._$target},findTarget:function(){if(this.type=="select"){this._$target=$("#"+this.targetPrefix+this.getToggleVal())}else{this._$target=$("#"+this.$toggle.attr("data-target"))}},getToggleVal:function(){return Garnish.getInputPostVal(this.$toggle)},onToggleChange:function(){if(this.type=="select"){this.hideTarget();this.findTarget();this.showTarget()}else{if(this.type=="link"){var show=this.$toggle.hasClass("collapsed")}else{var show=!!this.getToggleVal()}if(this.reverse){show=!show}if(show){this.showTarget()}else{this.hideTarget()}}},showTarget:function(){if(this.getTarget().length){this.getTarget().removeClass("hidden");if(this.type!="select"){if(this.type=="link"){this.$toggle.removeClass("collapsed");this.$toggle.addClass("expanded")}var $target=this.getTarget();$target.height("auto");var height=$target.height();$target.height(0);$target.stop().animate({height:height},"fast",$.proxy(function(){$target.height("auto")},this))}}},hideTarget:function(){if(this.getTarget().length){if(this.type=="select"){this.getTarget().addClass("hidden")}else{if(this.type=="link"){this.$toggle.removeClass("expanded");this.$toggle.addClass("collapsed")}this.getTarget().stop().animate({height:0},"fast",$.proxy(function(){this.getTarget().addClass("hidden")},this))}}}});Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,cols:null,colWidth:null,init:function(container,settings){this.$container=$(container);this.setSettings(settings,Craft.Grid.defaults);this.$items=this.$container.children(this.settings.itemSelector);this.setCols();this.addListener(Garnish.$win,"resize","setCols")},addItems:function(items){this.$items=$().add(this.$items.add(items));this.refreshCols()},removeItems:function(items){this.$items=$().add(this.$items.not(items));this.refreshCols()},setCols:function(){var totalCols=Math.floor(this.$container.width()/this.settings.minColWidth);if(totalCols==0){totalCols=1}if(totalCols!==this.totalCols){this.totalCols=totalCols;this.refreshCols();this.stretchColHeights();return true}return false},refreshCols:function(){if(this.settings.fillMode=="grid"){var itemIndex=0;while(itemIndex<this.$items.length){var tallestItemHeight=-1,colIndex=0;for(var i=itemIndex;(i<itemIndex+this.totalCols&&i<this.$items.length);i++){var itemHeight=$(this.$items[i]).height("auto").height();if(itemHeight>tallestItemHeight){tallestItemHeight=itemHeight}colIndex++}if(this.settings.snapToGrid){var remainder=tallestItemHeight%this.settings.snapToGrid;if(remainder){tallestItemHeight+=this.settings.snapToGrid-remainder}}for(var i=itemIndex;(i<itemIndex+this.totalCols&&i<this.$items.length);i++){$(this.$items[i]).height(tallestItemHeight)}itemIndex+=this.totalCols}}else{for(var i=0;i<this.$items.length;i++){$(this.$items[i]).detach()}if(this.cols){for(var i=0;i<this.cols.length;i++){this.cols[i].remove()}}this.cols=[];if(this.settings.percentageWidths){this.colWidth=Math.floor(100/this.totalCols)+"%"}else{this.colWidth=this.settings.minColWidth+"px"}var actualTotalCols=Math.min(this.totalCols,this.$items.length);for(var i=0;i<actualTotalCols;i++){this.cols[i]=new Craft.Grid.Col(this,i)}if(this.cols.length==1){for(var i=0;i<this.$items.length;i++){this.cols[0].append(this.$items[i]);if(this.settings.snapToGrid){var height=$(this.$items[i]).height("auto").height(),remainder=height%this.settings.snapToGrid;if(remainder){$(this.$items[i]).height(height+this.settings.snapToGrid-remainder)}}}}else{switch(this.settings.fillMode){case"top":for(var i=0;i<this.$items.length;i++){this.getShortestCol().append(this.$items[i])}break;case"ltr":this.itemHeights=[];this.ltrScenarios=[];this.totalItemHeight=0;for(var i=0;i<this.$items.length;i++){this.cols[0].append(this.$items[i]);this.itemHeights[i]=$(this.$items[i]).height();this.totalItemHeight+=this.itemHeights[i];$(this.$items[i]).detach()}this.avgColHeight=this.totalItemHeight/this.cols.length;this.ltrScenarios.push(new Craft.Grid.LtrScenario(this,0,0,[[]],0));var shortestScenario=this.ltrScenarios[0];for(var i=1;i<this.ltrScenarios.length;i++){if(this.ltrScenarios[i].tallestColHeight<shortestScenario.tallestColHeight){shortestScenario=this.ltrScenarios[i]}}for(var i=0;i<shortestScenario.placements.length;i++){for(var j=0;j<shortestScenario.placements[i].length;j++){this.cols[i].append(this.$items[shortestScenario.placements[i][j]])}}break}}}},getShortestCol:function(){var shortestCol,shortestColHeight;for(var i=0;i<this.cols.length;i++){var col=this.cols[i],colHeight=this.cols[i].height();if(typeof shortestCol=="undefined"||colHeight<shortestColHeight){shortestCol=col;shortestColHeight=colHeight}}return shortestCol},getTallestCol:function(){var tallestCol,tallestColHeight;for(var i=0;i<this.cols.length;i++){var col=this.cols[i],colHeight=this.cols[i].height();if(typeof tallestCol=="undefined"||colHeight>tallestColHeight){tallestCol=col;tallestColHeight=colHeight}}return tallestCol},stretchColHeights:function(){return;var minHeight=Garnish.$win.height()-101,tallestCol=this.getTallestCol(),height=Math.max(minHeight,tallestCol.height());for(var i=0;i<this.cols.length;i++){this.cols[i].height(height)}}},{defaults:{itemSelector:":visible",minColWidth:325,percentageWidths:true,fillMode:"grid",snapToGrid:null}});Craft.Grid.Col=Garnish.Base.extend({grid:null,index:null,$outerContainer:null,$innerContainer:null,init:function(grid,index){this.grid=grid;this.index=index;this.$outerContainer=$('<div class="col" style="width: '+this.grid.colWidth+'"/>').appendTo(this.grid.$container);this.$innerContainer=$('<div class="col-inner">').appendTo(this.$outerContainer)},height:function(height){if(typeof height!="undefined"){this.$innerContainer.height(height)}else{this.$innerContainer.height("auto");return this.$outerContainer.height()}},append:function(item){this.$innerContainer.append(item)},remove:function(){this.$outerContainer.remove()}});Craft.Grid.LtrScenario=Garnish.Base.extend({placements:null,tallestColHeight:null,init:function(grid,itemIndex,colIndex,placements,tallestColHeight){this.placements=placements;this.tallestColHeight=tallestColHeight;var runningColHeight=0;for(itemIndex;itemIndex<grid.$items.length;itemIndex++){var hypotheticalColHeight=runningColHeight+grid.itemHeights[itemIndex];if(hypotheticalColHeight<=grid.avgColHeight||colIndex==grid.cols.length-1){this.placements[colIndex].push(itemIndex);runningColHeight+=grid.itemHeights[itemIndex];this.checkColHeight(hypotheticalColHeight)}else{this.placements[colIndex+1]=[];var altPlacements=$.extend(true,[],this.placements);altPlacements[colIndex].push(itemIndex);var altTallestColHeight=Math.max(this.tallestColHeight,hypotheticalColHeight);grid.ltrScenarios.push(new Craft.Grid.LtrScenario(grid,itemIndex+1,colIndex+1,altPlacements,altTallestColHeight));colIndex++;this.placements[colIndex].push(itemIndex);this.checkColHeight(grid.itemHeights[itemIndex]);runningColHeight=grid.itemHeights[itemIndex]}}},checkColHeight:function(colHeight){if(colHeight>this.tallestColHeight){this.tallestColHeight=colHeight}}});Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(sourceVal){var handle=sourceVal.replace("/<(.*?)>/g","");handle=handle.toLowerCase();handle=Craft.asciiString(handle);handle=handle.replace(/^[^a-z]+/,"");var words=Craft.filterArray(handle.split(/[^a-z0-9]+/)),handle="";for(var i=0;i<words.length;i++){if(i==0){handle+=words[i]}else{handle+=words[i].charAt(0).toUpperCase()+words[i].substr(1)}}return handle}});Craft.ImageUpload=Garnish.Base.extend({_imageHandler:null,init:function(settings){this.setSettings(settings,Craft.ImageUpload.defaults);this._imageHandler=new Craft.ImageHandler(settings)}},{$modalContainerDiv:null,defaults:{postParameters:{},modalClass:"",uploadButton:{},uploadAction:"",deleteButton:{},deleteMessage:"",deleteAction:"",cropAction:"",areaToolOptions:{aspectRatio:"1:1",initialRectangle:{mode:"auto",x1:0,x2:0,y1:0,y2:0}},onImageDelete:function(response){location.reload()},onImageSave:function(response){location.reload()}}});Craft.ImageHandler=Garnish.Base.extend({modal:null,init:function(settings){this.setSettings(settings);var _this=this;var element=settings.uploadButton;var options={element:this.settings.uploadButton[0],action:Craft.actionUrl+"/"+this.settings.uploadAction,params:this.settings.postParameters,multiple:false,onComplete:function(fileId,fileName,response){if(Craft.ImageUpload.$modalContainerDiv==null){Craft.ImageUpload.$modalContainerDiv=$('<div class="modal"></div>').addClass(settings.modalClass).appendTo(Garnish.$bod)}if(response.html){Craft.ImageUpload.$modalContainerDiv.empty().append(response.html);if(!this.modal){this.modal=new Craft.ImageModal(Craft.ImageUpload.$modalContainerDiv,{postParameters:settings.postParameters,cropAction:settings.cropAction});this.modal.imageHandler=_this}else{this.modal.show()}this.modal.bindButtons();this.modal.addListener(this.modal.$saveBtn,"click","saveImage");this.modal.addListener(this.modal.$cancelBtn,"click","cancel");this.modal.removeListener(Garnish.Modal.$shade,"click");setTimeout($.proxy(function(){Craft.ImageUpload.$modalContainerDiv.find("img").load($.proxy(function(){var profileTool=new Craft.ImageAreaTool(settings.areaToolOptions);profileTool.showArea(this.modal)},this))},this),1)}},allowedExtensions:["jpg","jpeg","gif","png"],template:'<div class="QqUploader-uploader"><div class="QqUploader-upload-drop-area" style="display: none; "><span></span></div><div class="QqUploader-upload-button" style="position: relative; overflow: hidden; direction: ltr; ">'+element.text()+'<input type="file" name="file" style="position: absolute; right: 0px; top: 0px; font-family: Arial; font-size: 118px; margin: 0px; padding: 0px; cursor: pointer; opacity: 0; "></div><ul class="QqUploader-upload-list"></ul></div>'};options.sizeLimit=Craft.maxUploadSize;this.uploader=new qqUploader.FileUploader(options);$(settings.deleteButton).click(function(){if(confirm(settings.deleteMessage)){$(this).parent().append('<div class="blocking-modal"></div>');Craft.postActionRequest(settings.deleteAction,settings.postParameters,$.proxy(function(response){_this.onImageDelete.apply(_this,[response])},this))}})},onImageSave:function(data){this.settings.onImageSave.apply(this,[data])},onImageDelete:function(data){this.settings.onImageDelete.apply(this,[data])}});Craft.ImageModal=Garnish.Modal.extend({$container:null,$saveBtn:null,$cancelBtn:null,areaSelect:null,factor:null,source:null,_postParameters:null,_cropAction:"",imageHandler:null,init:function($container,settings){this.base($container,settings);this._postParameters=settings.postParameters;this._cropAction=settings.cropAction},bindButtons:function(){this.$saveBtn=this.$container.find(".submit:first");this.$cancelBtn=this.$container.find(".cancel:first")},cancel:function(){this.hide();this.areaSelect.setOptions({remove:true,hide:true,disable:true});this.$container.empty()},saveImage:function(){var selection=this.areaSelect.getSelection();var params={x1:Math.round(selection.x1/this.factor),x2:Math.round(selection.x2/this.factor),y1:Math.round(selection.y1/this.factor),y2:Math.round(selection.y2/this.factor),source:this.source};params=$.extend(this._postParameters,params);Craft.postActionRequest(this._cropAction,params,$.proxy(function(response){if(response.error){alert(response.error)}else{this.imageHandler.onImageSave.apply(this.imageHandler,[response])}this.hide();this.$container.empty();this.areaSelect.setOptions({remove:true,hide:true,disable:true})},this));this.areaSelect.setOptions({disable:true});this.removeListener(this.$saveBtn,"click");this.removeListener(this.$cancelBtn,"click");this.$container.find(".crop-image").fadeTo(50,0.5)}});Craft.ImageAreaTool=Garnish.Base.extend({$container:null,init:function(settings){this.$container=Craft.ImageUpload.$modalContainerDiv;this.setSettings(settings)},showArea:function(referenceObject){var $target=this.$container.find("img");var areaOptions={aspectRatio:this.settings.aspectRatio,maxWidth:$target.width(),maxHeight:$target.height(),instance:true,resizable:true,show:true,persistent:true,handles:true,parent:$target.parent()};var areaSelect=$target.imgAreaSelect(areaOptions);var x1=this.settings.initialRectangle.x1;var x2=this.settings.initialRectangle.x2;var y1=this.settings.initialRectangle.y1;var y2=this.settings.initialRectangle.y2;if(this.settings.initialRectangle.mode=="auto"){var proportions=this.settings.aspectRatio.split(":");var rectangleWidth=0;var rectangleHeight=0;if(proportions[0]>proportions[1]){rectangleWidth=$target.width();rectangleHeight=rectangleWidth*proportions[1]/proportions[0]}else{if(proportions[0]>proportions[1]){rectangleHeight=$target.height();rectangleWidth=rectangleHeight*proportions[0]/proportions[1]}else{rectangleHeight=rectangleWidth=Math.min($target.width(),$target.height())}}x1=Math.round(($target.width()-rectangleWidth)/2);y1=Math.round(($target.height()-rectangleHeight)/2);x2=x1+rectangleWidth;y2=y1+rectangleHeight}areaSelect.setSelection(x1,y1,x2,y2);areaSelect.update();referenceObject.areaSelect=areaSelect;referenceObject.factor=$target.attr("data-factor");referenceObject.source=$target.attr("src").split("/").pop()}});Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,$toggleTarget:null,on:null,dragger:null,dragStartMargin:null,init:function(outerContainer,settings){this.$outerContainer=$(outerContainer);if(this.$outerContainer.data("lightswitch")){Garnish.log("Double-instantiating a switch on an element");this.$outerContainer.data("lightswitch").destroy()}this.$outerContainer.data("lightswitch",this);this.setSettings(settings,Craft.LightSwitch.defaults);this.$innerContainer=this.$outerContainer.find(".container:first");this.$input=this.$outerContainer.find("input:first");this.$toggleTarget=$(this.$outerContainer.attr("data-toggle"));this.on=this.$outerContainer.hasClass("on");this.addListener(this.$outerContainer,"mousedown","_onMouseDown");this.addListener(this.$outerContainer,"keydown","_onKeyDown");this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreButtons:false,onDragStart:$.proxy(this,"_onDragStart"),onDrag:$.proxy(this,"_onDrag"),onDragStop:$.proxy(this,"_onDragStop")})},turnOn:function(){this.$innerContainer.stop().animate({marginLeft:0},"fast");this.$input.val("y");this.on=true;this.settings.onChange();this.$toggleTarget.show();this.$toggleTarget.height("auto");var height=this.$toggleTarget.height();this.$toggleTarget.height(0);this.$toggleTarget.stop().animate({height:height},"fast",$.proxy(function(){this.$toggleTarget.height("auto")},this))},turnOff:function(){this.$innerContainer.stop().animate({marginLeft:Craft.LightSwitch.offMargin},"fast");this.$input.val("");this.on=false;this.settings.onChange();this.$toggleTarget.stop().animate({height:0},"fast")},toggle:function(event){if(!this.on){this.turnOn()}else{this.turnOff()}},_onMouseDown:function(){this.addListener(Garnish.$doc,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Garnish.$doc,"mouseup");if(!this.dragger.dragging){this.toggle()}},_onKeyDown:function(event){switch(event.keyCode){case Garnish.SPACE_KEY:this.toggle();event.preventDefault();break;case Garnish.RIGHT_KEY:this.turnOn();event.preventDefault();break;case Garnish.LEFT_KEY:this.turnOff();event.preventDefault();break}},_getMargin:function(){return parseInt(this.$innerContainer.css("marginLeft"))},_onDragStart:function(){this.dragStartMargin=this._getMargin()},_onDrag:function(){var margin=this.dragStartMargin+this.dragger.mouseDistX;if(margin<Craft.LightSwitch.offMargin){margin=Craft.LightSwitch.offMargin}else{if(margin>0){margin=0}}this.$innerContainer.css("marginLeft",margin)},_onDragStop:function(){var margin=this._getMargin();if(margin>-16){this.turnOn()}else{this.turnOff()}},destroy:function(){this.base();this.dragger.destroy()}},{offMargin:-50,defaults:{onChange:function(){}}});Craft.ProgressBar=Garnish.Base.extend({$uploadProgress:null,$uploadProgressBar:null,_itemCount:0,_processedItemCount:0,init:function($element){this.$uploadProgress=$element;this.$uploadProgressBar=$(".assets-pb-bar",this.$uploadProgress);this.resetProgressBar()},resetProgressBar:function(){this.setItemCount(1);this.setProcessedItemCount(0);this.updateProgressBar()},hideProgressBar:function(){this.$uploadProgress.fadeTo("fast",0.01,$.proxy(function(){this.$uploadProgress.addClass("hidden").fadeTo(1,1,function(){})},this))},showProgressBar:function(){this.$uploadProgress.removeClass("hidden")},setItemCount:function(count){this._itemCount=count},incrementItemCount:function(count){this._itemCount+=count},setProcessedItemCount:function(count){this._processedItemCount=count},incrementProcessedItemCount:function(count){this._processedItemCount+=count},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var width=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(width)},setProgressPercentage:function(percentage){this.$uploadProgressBar.width(percentage+"%")}});Craft.PromptHandler=Garnish.Base.extend({$modalContainerDiv:null,$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$promptButtons:null,_prompts:[],_promptBatchCallback:$.noop,_promptBatchReturnData:[],_promptBatchNum:0,init:function(){},resetPrompts:function(){this._prompts=[];this._promptBatchCallback=$.noop;this._promptBatchReturnData=[];this._promptBatchNum=0},addPrompt:function(prompt){this._prompts.push(prompt)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(callback){this._promptBatchCallback=callback;this._promptBatchReturnData=[];this._promptBatchNum=0;this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var prompt=this._prompts[this._promptBatchNum].prompt,remainingInBatch=this._prompts.length-(this._promptBatchNum+1);this._showPrompt(prompt.message,prompt.choices,$.proxy(this,"_handleBatchPromptSelection"),remainingInBatch)},_handleBatchPromptSelection:function(choice,applyToRemaining){var prompt=this._prompts[this._promptBatchNum],remainingInBatch=this._prompts.length-(this._promptBatchNum+1);var choiceData=$.extend(prompt,{choice:choice});this._promptBatchReturnData.push(choiceData);if(remainingInBatch){this._promptBatchNum++;if(applyToRemaining){this._handleBatchPromptSelection(choice,true)}else{this._showNextPromptInBatch()}}else{if(typeof this._promptBatchCallback=="function"){this._promptBatchCallback(this._promptBatchReturnData)}}},_showPrompt:function(message,choices,callback,itemsToGo){this._promptCallback=callback;if(this.modal==null){this.modal=new Garnish.Modal({closeOtherModals:false})}if(this.$modalContainerDiv==null){this.$modalContainerDiv=$('<div class="modal prompt-modal"></div>').addClass().appendTo(Garnish.$bod)}this.$prompt=$('<div class="body"></div>').appendTo(this.$modalContainerDiv.empty());this.$promptMessage=$('<p class="prompt-msg"/>').appendTo(this.$prompt);$("<p>").html(Craft.t("What do you want to do?")).appendTo(this.$prompt);this.$promptApplyToRemainingContainer=$('<label class="assets-applytoremaining"/>').appendTo(this.$prompt).hide();this.$promptApplyToRemainingCheckbox=$('<input type="checkbox"/>').appendTo(this.$promptApplyToRemainingContainer);this.$promptApplyToRemainingLabel=$("<span/>").appendTo(this.$promptApplyToRemainingContainer);this.$promptButtons=$('<div class="buttons"/>').appendTo(this.$prompt);this.modal.setContainer(this.$modalContainerDiv);this.$promptMessage.html(message);for(var i=0;i<choices.length;i++){var $btn=$('<div class="btn" data-choice="'+choices[i].value+'">'+choices[i].title+"</div>");this.addListener($btn,"activate",function(ev){var choice=ev.currentTarget.getAttribute("data-choice"),applyToRemaining=this.$promptApplyToRemainingCheckbox.prop("checked");this._selectPromptChoice(choice,applyToRemaining)});this.$promptButtons.append($btn).append("<br />")}if(itemsToGo){this.$promptApplyToRemainingContainer.show();this.$promptApplyToRemainingLabel.html(" "+Craft.t("Apply this to the {number} remaining conflicts?",{number:itemsToGo}))}this.modal.show();this.modal.removeListener(Garnish.Modal.$shade,"click");this.addListener(Garnish.Modal.$shade,"click","_cancelPrompt")},_selectPromptChoice:function(choice,applyToRemaining){this.$prompt.fadeOut("fast",$.proxy(function(){this.modal.hide();this._promptCallback(choice,applyToRemaining)},this))},_cancelPrompt:function(){this._selectPromptChoice("cancel",true)},});(function(){var QqUploader=QqUploader||{};QqUploader.extend=function(first,second){for(var prop in second){first[prop]=second[prop]}};QqUploader.indexOf=function(arr,elt,from){if(arr.indexOf){return arr.indexOf(elt,from)}from=from||0;var len=arr.length;if(from<0){from+=len}for(;from<len;from++){if(from in arr&&arr[from]===elt){return from}}return -1};QqUploader.getUniqueId=(function(){var id=0;return function(){return id++}})();QqUploader.attach=function(element,type,fn){if(element.addEventListener){element.addEventListener(type,fn,false)}else{if(element.attachEvent){element.attachEvent("on"+type,fn)}}};QqUploader.detach=function(element,type,fn){if(element.removeEventListener){element.removeEventListener(type,fn,false)}else{if(element.attachEvent){element.detachEvent("on"+type,fn)}}};QqUploader.preventDefault=function(e){if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}};QqUploader.insertBefore=function(a,b){b.parentNode.insertBefore(a,b)};QqUploader.remove=function(element){element.parentNode.removeChild(element)};QqUploader.contains=function(parent,descendant){if(parent==descendant){return true}if(parent.contains){return parent.contains(descendant)}else{return !!(descendant.compareDocumentPosition(parent)&8)}};QqUploader.toElement=(function(){var div=document.createElement("div");return function(html){div.innerHTML=html;var element=div.firstChild;div.removeChild(element);return element}})();QqUploader.css=function(element,styles){if(styles.opacity!=null){if(typeof element.style.opacity!="string"&&typeof(element.filters)!="undefined"){styles.filter="alpha(opacity="+Math.round(100*styles.opacity)+")"}}QqUploader.extend(element.style,styles)};QqUploader.hasClass=function(element,name){var re=new RegExp("(^| )"+name+"( |$)");return re.test(element.className)};QqUploader.addClass=function(element,name){if(!QqUploader.hasClass(element,name)){element.className+=" "+name}};QqUploader.removeClass=function(element,name){var re=new RegExp("(^| )"+name+"( |$)");element.className=element.className.replace(re," ").replace(/^\s+|\s+$/g,"")};QqUploader.setText=function(element,text){element.innerText=text;element.textContent=text};QqUploader.children=function(element){var children=[],child=element.firstChild;while(child){if(child.nodeType==1){children.push(child)}child=child.nextSibling}return children};QqUploader.getByClass=function(element,className){if(element.querySelectorAll){return element.querySelectorAll("."+className)}var result=[];var candidates=element.getElementsByTagName("*");var len=candidates.length;for(var i=0;i<len;i++){if(QqUploader.hasClass(candidates[i],className)){result.push(candidates[i])}}return result};QqUploader.obj2url=function(obj,temp,prefixDone){var uristrings=[],prefix="&",add=function(nextObj,i){var nextTemp=temp?(/\[\]$/.test(temp))?temp:temp+"["+i+"]":i;if((nextTemp!="undefined")&&(i!="undefined")){uristrings.push((typeof nextObj==="object")?QqUploader.obj2url(nextObj,nextTemp,true):(Object.prototype.toString.call(nextObj)==="[object Function]")?encodeURIComponent(nextTemp)+"="+encodeURIComponent(nextObj()):encodeURIComponent(nextTemp)+"="+encodeURIComponent(nextObj))}};if(!prefixDone&&temp){prefix=(/\?/.test(temp))?(/\?$/.test(temp))?"":"&":"?";uristrings.push(temp);uristrings.push(QqUploader.obj2url(obj))}else{if((Object.prototype.toString.call(obj)==="[object Array]")&&(typeof obj!="undefined")){for(var i=0,len=obj.length;i<len;++i){add(obj[i],i)}}else{if((typeof obj!="undefined")&&(obj!==null)&&(typeof obj==="object")){for(var i in obj){add(obj[i],i)}}else{uristrings.push(encodeURIComponent(temp)+"="+encodeURIComponent(obj))}}}return uristrings.join(prefix).replace(/^&/,"").replace(/%20/g,"+")};var QqUploader=QqUploader||{};QqUploader.FileUploaderBasic=function(o){this._options={debug:false,action:"/server/upload",params:{},button:null,multiple:true,maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,onSubmit:function(id,fileName){},onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,responseJSON){},onCancel:function(id,fileName){},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},showMessage:function(message){alert(message)}};QqUploader.extend(this._options,o);this._filesInProgress=0;this._handler=this._createUploadHandler();if(this._options.button){this._button=this._createUploadButton(this._options.button)}this._preventLeaveInProgress()};QqUploader.FileUploaderBasic.prototype={setParams:function(params){this._options.params=params},getInProgress:function(){return this._filesInProgress},_createUploadButton:function(element){var self=this;return new QqUploader.UploadButton({element:element,multiple:this._options.multiple&&QqUploader.UploadHandlerXhr.isSupported(),onChange:function(input){self._onInputChange(input)}})},_createUploadHandler:function(){var self=this,handlerClass;if(QqUploader.UploadHandlerXhr.isSupported()){handlerClass="UploadHandlerXhr"}else{handlerClass="UploadHandlerForm"}var handler=new QqUploader[handlerClass]({debug:this._options.debug,action:this._options.action,maxConnections:this._options.maxConnections,onProgress:function(id,fileName,loaded,total){self._onProgress(id,fileName,loaded,total);self._options.onProgress(id,fileName,loaded,total)},onComplete:function(id,fileName,result){self._onComplete(id,fileName,result);self._options.onComplete(id,fileName,result)},onCancel:function(id,fileName){self._onCancel(id,fileName);self._options.onCancel(id,fileName)}});return handler},_preventLeaveInProgress:function(){var self=this;QqUploader.attach(window,"beforeunload",function(e){if(!self._filesInProgress){return}var e=e||window.event;e.returnValue=self._options.messages.onLeave;return self._options.messages.onLeave})},_onSubmit:function(id,fileName){this._filesInProgress++},_onProgress:function(id,fileName,loaded,total){},_onComplete:function(id,fileName,result){this._filesInProgress--;if(result.error){this._options.showMessage(result.error)}},_onCancel:function(id,fileName){this._filesInProgress--},_onInputChange:function(input){if(this._handler instanceof QqUploader.UploadHandlerXhr){this._uploadFileList(input.files)}else{if(this._validateFile(input)){this._uploadFile(input)}}this._button.reset()},_uploadFileList:function(files){for(var i=0;i<files.length;i++){if(!this._validateFile(files[i])){return}}for(var i=0;i<files.length;i++){this._uploadFile(files[i])}},_uploadFile:function(fileContainer){var id=this._handler.add(fileContainer);var fileName=this._handler.getName(id);if(this._options.onSubmit(id,fileName)!==false){this._onSubmit(id,fileName);this._handler.upload(id,this._options.params)}},_validateFile:function(file){var name,size;if(file.value){name=file.value.replace(/.*(\/|\\)/,"")}else{name=file.fileName!=null?file.fileName:file.name;size=file.fileSize!=null?file.fileSize:file.size}if(!this._isAllowedExtension(name)){this._error("typeError",name);return false}else{if(size===0){this._error("emptyError",name);return false}else{if(size&&this._options.sizeLimit&&size>this._options.sizeLimit){this._error("sizeError",name);return false}else{if(size&&size<this._options.minSizeLimit){this._error("minSizeError",name);return false}}}}return true},_error:function(code,fileName){var message=this._options.messages[code];function r(name,replacement){message=message.replace(name,replacement)}r("{file}",this._formatFileName(fileName));r("{extensions}",this._options.allowedExtensions.join(", "));r("{sizeLimit}",this._formatSize(this._options.sizeLimit));r("{minSizeLimit}",this._formatSize(this._options.minSizeLimit));this._options.showMessage(message)},_formatFileName:function(name){if(name.length>33){name=name.slice(0,19)+"..."+name.slice(-13)}return name},_isAllowedExtension:function(fileName){var ext=(-1!==fileName.indexOf("."))?fileName.replace(/.*[.]/,"").toLowerCase():"";var allowed=this._options.allowedExtensions;if(!allowed.length){return true}for(var i=0;i<allowed.length;i++){if(allowed[i].toLowerCase()==ext){return true}}return false},_formatSize:function(bytes){var i=-1;do{bytes=bytes/1024;i++}while(bytes>99);return Math.max(bytes,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][i]}};QqUploader.FileUploader=function(o){QqUploader.FileUploaderBasic.apply(this,arguments);QqUploader.extend(this._options,{element:null,listElement:null,template:'<div class="QqUploader-uploader"><div class="QqUploader-upload-drop-area"><span>Drop files here to upload</span></div><div class="QqUploader-upload-button">Upload a file</div><ul class="QqUploader-upload-list"></ul></div>',fileTemplate:'<li><span class="QqUploader-upload-file"></span><span class="QqUploader-upload-spinner"></span><span class="QqUploader-upload-size"></span><a class="QqUploader-upload-cancel" href="#">Cancel</a><span class="QqUploader-upload-failed-text">Failed</span></li>',classes:{button:"QqUploader-upload-button",drop:"QqUploader-upload-drop-area",dropActive:"QqUploader-upload-drop-area-active",list:"QqUploader-upload-list",file:"QqUploader-upload-file",spinner:"QqUploader-upload-spinner",size:"QqUploader-upload-size",cancel:"QqUploader-upload-cancel",success:"QqUploader-upload-success",fail:"QqUploader-upload-fail"}});QqUploader.extend(this._options,o);this._element=this._options.element;this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||this._find(this._element,"list");this._classes=this._options.classes;this._button=this._createUploadButton(this._find(this._element,"button"));this._bindCancelEvent();this._setupDragDrop()};QqUploader.extend(QqUploader.FileUploader.prototype,QqUploader.FileUploaderBasic.prototype);QqUploader.extend(QqUploader.FileUploader.prototype,{_find:function(parent,type){var element=QqUploader.getByClass(parent,this._options.classes[type])[0];if(!element){throw new Error("element not found: "+type)}return element},_setupDragDrop:function(){var self=this,dropArea=this._find(this._element,"drop");var dz=new QqUploader.UploadDropZone({element:dropArea,onEnter:function(e){QqUploader.addClass(dropArea,self._classes.dropActive);e.stopPropagation()},onLeave:function(e){e.stopPropagation()},onLeaveNotDescendants:function(e){QqUploader.removeClass(dropArea,self._classes.dropActive)},onDrop:function(e){dropArea.style.display="none";QqUploader.removeClass(dropArea,self._classes.dropActive);self._uploadFileList(e.dataTransfer.files)}});dropArea.style.display="none";QqUploader.attach(document,"dragenter",function(e){if(!dz._isValidFileDrag(e)){return}dropArea.style.display="block"});QqUploader.attach(document,"dragleave",function(e){if(!dz._isValidFileDrag(e)){return}var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(!relatedTarget||relatedTarget.nodeName=="HTML"){dropArea.style.display="none"}})},_onSubmit:function(id,fileName){QqUploader.FileUploaderBasic.prototype._onSubmit.apply(this,arguments);this._addToList(id,fileName)},_onProgress:function(id,fileName,loaded,total){QqUploader.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var item=this._getItemByFileId(id);var size=this._find(item,"size");size.style.display="inline";var text;if(loaded!=total){text=Math.round(loaded/total*100)+"% from "+this._formatSize(total)}else{text=this._formatSize(total)}QqUploader.setText(size,text)},_onComplete:function(id,fileName,result){QqUploader.FileUploaderBasic.prototype._onComplete.apply(this,arguments);var item=this._getItemByFileId(id);QqUploader.remove(this._find(item,"cancel"));QqUploader.remove(this._find(item,"spinner"));if(result.success){QqUploader.addClass(item,this._classes.success)}else{QqUploader.addClass(item,this._classes.fail)}},_addToList:function(id,fileName){var item=QqUploader.toElement(this._options.fileTemplate);item.qqfileId=id;var fileElement=this._find(item,"file");QqUploader.setText(fileElement,this._formatFileName(fileName));this._find(item,"size").style.display="none";this._listElement.appendChild(item)},_getItemByFileId:function(id){var item=this._listElement.firstChild;while(item){if(item.qqfileId==id){return item}item=item.nextSibling}},_bindCancelEvent:function(){var self=this,list=this._listElement;QqUploader.attach(list,"click",function(e){e=e||window.event;var target=e.target||e.srcElement;if(QqUploader.hasClass(target,self._classes.cancel)){QqUploader.preventDefault(e);var item=target.parentNode;self._handler.cancel(item.qqfileId);QqUploader.remove(item)}})}});QqUploader.UploadDropZone=function(o){this._options={element:null,onEnter:function(e){},onLeave:function(e){},onLeaveNotDescendants:function(e){},onDrop:function(e){}};QqUploader.extend(this._options,o);this._element=this._options.element;this._disableDropOutside();this._attachEvents()};QqUploader.UploadDropZone.prototype={_disableDropOutside:function(e){if(!QqUploader.UploadDropZone.dropOutsideDisabled){QqUploader.attach(document,"dragover",function(e){if(e.dataTransfer){e.dataTransfer.dropEffect="none";e.preventDefault()}});QqUploader.UploadDropZone.dropOutsideDisabled=true}},_attachEvents:function(){var self=this;QqUploader.attach(self._element,"dragover",function(e){if(!self._isValidFileDrag(e)){return}var effect=e.dataTransfer.effectAllowed;if(effect=="move"||effect=="linkMove"){e.dataTransfer.dropEffect="move"}else{e.dataTransfer.dropEffect="copy"}e.stopPropagation();e.preventDefault()});QqUploader.attach(self._element,"dragenter",function(e){if(!self._isValidFileDrag(e)){return}self._options.onEnter(e)});QqUploader.attach(self._element,"dragleave",function(e){if(!self._isValidFileDrag(e)){return}self._options.onLeave(e);var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(QqUploader.contains(this,relatedTarget)){return}self._options.onLeaveNotDescendants(e)});QqUploader.attach(self._element,"drop",function(e){if(!self._isValidFileDrag(e)){return}e.preventDefault();self._options.onDrop(e)})},_isValidFileDrag:function(e){var dt=e.dataTransfer,isWebkit=navigator.userAgent.indexOf("AppleWebKit")>-1;return dt&&dt.effectAllowed!="none"&&(dt.files||(!isWebkit&&dt.types.contains&&dt.types.contains("Files")))}};QqUploader.UploadButton=function(o){this._options={element:null,multiple:false,name:"file",onChange:function(input){},hoverClass:"QqUploader-upload-button-hover",focusClass:"QqUploader-upload-button-focus"};QqUploader.extend(this._options,o);this._element=this._options.element;QqUploader.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"});this._input=this._createInput()};QqUploader.UploadButton.prototype={getInput:function(){return this._input},reset:function(){if(this._input.parentNode){QqUploader.remove(this._input)}QqUploader.removeClass(this._element,this._options.focusClass);this._input=this._createInput()},_createInput:function(){var input=document.createElement("input");if(this._options.multiple){input.setAttribute("multiple","multiple")}input.setAttribute("type","file");input.setAttribute("name",this._options.name);QqUploader.css(input,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0});this._element.appendChild(input);var self=this;QqUploader.attach(input,"change",function(){self._options.onChange(input)});QqUploader.attach(input,"mouseover",function(){QqUploader.addClass(self._element,self._options.hoverClass)});QqUploader.attach(input,"mouseout",function(){QqUploader.removeClass(self._element,self._options.hoverClass)});QqUploader.attach(input,"focus",function(){QqUploader.addClass(self._element,self._options.focusClass)});QqUploader.attach(input,"blur",function(){QqUploader.removeClass(self._element,self._options.focusClass)});if(window.attachEvent){input.setAttribute("tabIndex","-1")}return input}};QqUploader.UploadHandlerAbstract=function(o){this._options={debug:false,action:"/upload.php",maxConnections:999,onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,response){},onCancel:function(id,fileName){}};QqUploader.extend(this._options,o);this._queue=[];this._params=[]};QqUploader.UploadHandlerAbstract.prototype={log:function(str){if(this._options.debug&&window.console){console.log("[uploader] "+str)}},add:function(file){},upload:function(id,params){var len=this._queue.push(id);var copy={};QqUploader.extend(copy,params);this._params[id]=copy;if(len<=this._options.maxConnections){this._upload(id,this._params[id])}},cancel:function(id){this._cancel(id);this._dequeue(id)},cancelAll:function(){for(var i=0;i<this._queue.length;i++){this._cancel(this._queue[i])}this._queue=[]},getName:function(id){},getSize:function(id){},getQueue:function(){return this._queue},_upload:function(id){},_cancel:function(id){},_dequeue:function(id){var i=QqUploader.indexOf(this._queue,id);this._queue.splice(i,1);var max=this._options.maxConnections;if(this._queue.length>=max&&i<max){var nextId=this._queue[max-1];this._upload(nextId,this._params[nextId])}}};QqUploader.UploadHandlerForm=function(o){QqUploader.UploadHandlerAbstract.apply(this,arguments);this._inputs={}};QqUploader.extend(QqUploader.UploadHandlerForm.prototype,QqUploader.UploadHandlerAbstract.prototype);QqUploader.extend(QqUploader.UploadHandlerForm.prototype,{add:function(fileInput){fileInput.setAttribute("name","qqfile");var id="QqUploader-upload-handler-iframe"+QqUploader.getUniqueId();this._inputs[id]=fileInput;if(fileInput.parentNode){QqUploader.remove(fileInput)}return id},getName:function(id){return this._inputs[id].value.replace(/.*(\/|\\)/,"")},_cancel:function(id){this._options.onCancel(id,this.getName(id));delete this._inputs[id];var iframe=document.getElementById(id);if(iframe){iframe.setAttribute("src","javascript:false;");QqUploader.remove(iframe)}},_upload:function(id,params){var input=this._inputs[id];if(!input){throw new Error("file with passed id was not added, or already uploaded or cancelled")}var fileName=this.getName(id);var iframe=this._createIframe(id);var form=this._createForm(iframe,params);form.appendChild(input);var self=this;this._attachLoadEvent(iframe,function(){self.log("iframe loaded");var response=self._getIframeContentJSON(iframe);self._options.onComplete(id,fileName,response);self._dequeue(id);delete self._inputs[id];setTimeout(function(){QqUploader.remove(iframe)},1)});form.submit();QqUploader.remove(form);return id},_attachLoadEvent:function(iframe,callback){QqUploader.attach(iframe,"load",function(){if(!iframe.parentNode){return}if(iframe.contentDocument&&iframe.contentDocument.body&&iframe.contentDocument.body.innerHTML=="false"){return}callback()})},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;this.log("converting iframe's innerHTML to JSON");this.log("innerHTML = "+doc.body.innerHTML);try{response=eval("("+doc.body.innerHTML+")")}catch(err){response={}}return response},_createIframe:function(id){var iframe=QqUploader.toElement('<iframe src="javascript:false;" name="'+id+'" />');iframe.setAttribute("id",id);iframe.style.display="none";document.body.appendChild(iframe);return iframe},_createForm:function(iframe,params){var form=QqUploader.toElement('<form method="post" enctype="multipart/form-data"></form>');var queryString=QqUploader.obj2url(params,this._options.action);form.setAttribute("action",queryString);form.setAttribute("target",iframe.name);form.style.display="none";document.body.appendChild(form);return form}});QqUploader.UploadHandlerXhr=function(o){QqUploader.UploadHandlerAbstract.apply(this,arguments);this._files=[];this._xhrs=[];this._loaded=[]};QqUploader.UploadHandlerXhr.isSupported=function(){var input=document.createElement("input");input.type="file";return("multiple" in input&&typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined")};QqUploader.extend(QqUploader.UploadHandlerXhr.prototype,QqUploader.UploadHandlerAbstract.prototype);QqUploader.extend(QqUploader.UploadHandlerXhr.prototype,{add:function(file){if(!(file instanceof File)){throw new Error("Passed obj in not a File (in QqUploader.UploadHandlerXhr)")}return this._files.push(file)-1},getName:function(id){var file=this._files[id];return file.fileName!=null?file.fileName:file.name},getSize:function(id){var file=this._files[id];return file.fileSize!=null?file.fileSize:file.size},getLoaded:function(id){return this._loaded[id]||0},_upload:function(id,params){var file=this._files[id],name=this.getName(id),size=this.getSize(id);this._loaded[id]=0;var xhr=this._xhrs[id]=new XMLHttpRequest();var self=this;xhr.upload.onprogress=function(e){if(e.lengthComputable){self._loaded[id]=e.loaded;self._options.onProgress(id,name,e.loaded,e.total)}};xhr.onreadystatechange=function(){if(xhr.readyState==4){self._onComplete(id,xhr)}};params=params||{};params.qqfile=name;var queryString=QqUploader.obj2url(params,this._options.action);xhr.open("POST",queryString,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("X-File-Name",encodeURIComponent(name));xhr.setRequestHeader("Content-Type","application/octet-stream");xhr.send(file)},_onComplete:function(id,xhr){if(!this._files[id]){return}var name=this.getName(id);var size=this.getSize(id);this._options.onProgress(id,name,size,size);if(xhr.status==200){this.log("xhr - server response received");this.log("responseText = "+xhr.responseText);var response;try{response=eval("("+xhr.responseText+")")}catch(err){response={}}this._options.onComplete(id,name,response)}else{this._options.onComplete(id,name,{})}this._files[id]=null;this._xhrs[id]=null;this._dequeue(id)},_cancel:function(id){this._options.onCancel(id,this.getName(id));this._files[id]=null;if(this._xhrs[id]){this._xhrs[id].abort();this._xhrs[id]=null}}});window.qqUploader=QqUploader})();Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(sourceVal){sourceVal=sourceVal.replace("/<(.*?)>/g","");sourceVal=sourceVal.replace("/['’]/g","");sourceVal=sourceVal.toLowerCase();sourceVal=Craft.asciiString(sourceVal);sourceVal=sourceVal.replace(/^[^a-z0-9]+/,"");sourceVal=sourceVal.replace(/[^a-z0-9]+$/,"");var words=Craft.filterArray(sourceVal.split(/[^a-z0-9]+/));if(words.length){return words.join("-")}else{return""}}});Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({id:null,name:null,source:null,elementId:null,elementSort:null,searchTimeout:null,menu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,init:function(id,name,source,elementId,hasFields){this.id=id;this.name=name;this.source=source;this.elementId=elementId;this.$container=$("#"+this.id);this.$elementsContainer=this.$container.children(".elements");this.$elements=this.$elementsContainer.children();this.$addTagInput=this.$container.children(".add").children(".text");this.$spinner=this.$addTagInput.next();this.totalElements=this.$elements.length;this.elementSelect=new Garnish.Select(this.$elements,{multi:true,filter:":not(.delete)"});this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:$.proxy(function(){return this.elementSelect.getSelectedItems()},this),caboose:$('<div class="caboose"/>'),onSortChange:$.proxy(function(){this.elementSelect.resetItemOrder()},this)});this.initElements(this.$elements);this.addListener(this.$addTagInput,"textchange",$.proxy(function(){if(this.searchTimeout){clearTimeout(this.searchTimeout)}this.searchTimeout=setTimeout($.proxy(this,"searchForTags"),500)},this));this.addListener(this.$addTagInput,"keypress",function(ev){if(ev.keyCode==Garnish.RETURN_KEY){ev.preventDefault();if(this.searchMenu){this.selectTag(this.searchMenu.$options[0])}}});this.addListener(this.$addTagInput,"focus",function(){if(this.searchMenu){this.searchMenu.show()}});this.addListener(this.$addTagInput,"blur",function(){setTimeout($.proxy(function(){if(this.searchMenu){this.searchMenu.hide()}},this),1)});if(hasFields){this._attachHUDEvents()}},searchForTags:function(){if(this.searchMenu){this.killSearchMenu()}var val=this.$addTagInput.val();if(val){this.$spinner.removeClass("hidden");var excludeIds=[];for(var i=0;i<this.$elements.length;i++){var id=$(this.$elements[i]).data("id");if(id){excludeIds.push(id)}}if(this.elementId){excludeIds.push(this.elementId)}var data={search:this.$addTagInput.val(),source:this.source,excludeIds:excludeIds,};Craft.postActionRequest("tags/searchForTags",data,$.proxy(function(response){var $menu=$('<div class="menu tagmenu"/>').appendTo(Garnish.$bod),$ul=$("<ul/>").appendTo($menu);if(!response.exactMatch){var $li=$("<li/>").appendTo($ul);$('<a class="hover"/>').appendTo($li).text(data.search)}for(var i=0;i<response.tags.length;i++){var $li=$("<li/>").appendTo($ul),$a=$("<a/>").appendTo($li).text(response.tags[i].name).data("id",response.tags[i].id);if(response.exactMatch&&i==0){$a.addClass("hover")}}this.searchMenu=new Garnish.Menu($menu,{attachToElement:this.$addTagInput,onOptionSelect:$.proxy(this,"selectTag")});this.searchMenu.show();this.$spinner.addClass("hidden")},this))}else{this.$spinner.addClass("hidden")}},selectTag:function(option){var $option=$(option);var $element=$('<div class="element removable"/>').appendTo(this.$elementsContainer),$input=$('<input type="hidden" name="'+this.name+'[]"/>').appendTo($element);if($option.data("id")){$element.data("id",$option.data("id"));$input.val($option.data("id"))}else{$input.val("new:"+$option.text())}$('<a class="delete icon" title="'+Craft.t("Remove")+'"></a>').appendTo($element);$('<span class="label">'+$option.text()+"</span>").appendTo($element);var margin=-($element.outerWidth()+10);this.$addTagInput.css("margin-left",margin+"px");this.$addTagInput.animate({marginLeft:0},"fast");this.$elements=this.$elements.add($element);this.totalElements++;this.initElements($element);this.killSearchMenu();this.$addTagInput.val("");this.$addTagInput.focus()},killSearchMenu:function(){this.searchMenu.hide();this.searchMenu.destroy();this.searchMenu=null},_attachHUDEvents:function(){this.removeListener(this.$elements,"dlbclick");this.addListener(this.$elements,"dblclick",$.proxy(this,"_editProperties"))},_editProperties:function(event){var $target=$(event.currentTarget);if(!$target.data("ElementEditor")){var settings={elementId:$target.attr("data-id"),$trigger:$target,loadContentAction:"tags/editTagContent",saveContentAction:"tags/saveTagContent"};$target.data("ElementEditor",new Craft.ElementEditor(settings))}$target.data("ElementEditor").show()}});Craft.Uploader=Garnish.Base.extend({uploader:null,init:function($element,settings){settings=$.extend(this.defaultSettings,settings);settings.element=$element[0];this.uploader=new qqUploader.FileUploader(settings)},setParams:function(paramObject){this.uploader.setParams(paramObject)},getInProgress:function(){return this.uploader.getInProgress()},defaultSettings:{action:Craft.actionUrl+"/assets/uploadFile",template:'<div class="assets-qq-uploader"><div class="assets-qq-upload-drop-area"></div><a href="javascript:;" class="btn submit assets-qq-upload-button" data-icon="↑" style="position: relative; overflow: hidden; direction: ltr; " role="button">'+Craft.t("Upload files")+'</a><ul class="assets-qq-upload-list hidden"></ul></div>',fileTemplate:'<li><span class="assets-qq-upload-file"></span><span class="assets-qq-upload-spinner"></span><span class="assets-qq-upload-size"></span><a class="assets-qq-upload-cancel" href="#">Cancel</a><span class="assets-qq-upload-failed-text">Failed</span></li>',classes:{button:"assets-qq-upload-button",drop:"assets-qq-upload-drop-area",dropActive:"assets-qq-upload-drop-area-active",list:"assets-qq-upload-list",file:"assets-qq-upload-file",spinner:"assets-qq-upload-spinner",size:"assets-qq-upload-size",cancel:"assets-qq-upload-cancel",success:"assets-qq-upload-success",fail:"assets-qq-upload-fail"},onSubmit:$.noop,onProgress:$.noop,onComplete:$.noop}})})(jQuery);