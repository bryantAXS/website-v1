/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */
(function(a){Craft.Tool=Garnish.Base.extend({$trigger:null,$form:null,$progressBar:null,$innerProgressBar:null,toolClass:null,optionsHtml:null,buttonLabel:null,hud:null,totalActions:null,completedActions:null,loadingActions:null,queue:null,init:function(b,c,d){this.toolClass=b;this.optionsHtml=c;this.buttonLabel=d;this.$trigger=a("#tool-"+b);this.addListener(this.$trigger,"click","showHUD")},showHUD:function(b){b.stopPropagation();if(!this.hud){this.$form=a("<form/>").html(this.optionsHtml+'<div class="buttons"><input type="submit" class="btn submit" value="'+this.buttonLabel+'"></div>');this.hud=new Garnish.HUD(this.$trigger,this.$form,{hudClass:"hud toolhud",triggerSpacing:10,tipWidth:30});Craft.initUiElements(this.$form);this.addListener(this.$form,"submit","onSubmit")}else{this.hud.show()}},onSubmit:function(b){b.preventDefault();if(!this.$progressBar){this.$progressBar=a('<div class="progressbar pending"/>').appendTo(this.hud.$body);this.$innerProgressBar=a('<div class="progressbar-inner"/>').appendTo(this.$progressBar)}else{this.$progressBar.addClass("pending")}this.totalActions=1;this.completedActions=0;this.queue=[];this.loadingActions=0;this.currentBatchQueue=[];this.$progressBar.css({top:Math.round(this.hud.$body.outerHeight()/2)-6});this.$form.stop().animate({left:-200},"fast");this.$progressBar.stop().animate({left:30},"fast",a.proxy(function(){var c=Garnish.getPostData(this.$form),d=Craft.expandPostArray(c);d.start=true;this.loadAction({params:d})},this))},updateProgressBar:function(){this.$progressBar.removeClass("pending");var b=(100*this.completedActions/this.totalActions)+"%";this.$innerProgressBar.width(b)},loadAction:function(b){this.loadingActions++;if(typeof b.confirm!="undefined"&&b.confirm){this.showConfirmDialog(b)}else{this.postActionRequest(b.params)}},showConfirmDialog:function(i){var f=a('<form class="modal confirmmodal"/>').appendTo(Garnish.$bod),h=a('<div class="body"/>').appendTo(f).html(i.confirm),d=a('<footer class="footer"/>').appendTo(f),e=a('<div class="buttons right"/>').appendTo(d),c=a('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(e),b=a('<input type="submit" class="btn submit" value="'+Craft.t("OK")+'"/>').appendTo(e);Craft.initUiElements(h);var g=new Garnish.Modal(f,{onHide:a.proxy(this,"onActionResponse")});this.addListener(c,"click",function(){g.hide()});this.addListener(f,"submit",function(k){k.preventDefault();g.settings.onHide=a.noop;g.hide();var j=Garnish.getPostData(h);var l=Craft.expandPostArray(j);a.extend(l,i.params);this.postActionRequest(l)})},postActionRequest:function(c){var b={tool:this.toolClass,params:c};Craft.postActionRequest("tools/performAction",b,a.proxy(this,"onActionResponse"))},onActionResponse:function(b){this.loadingActions--;this.completedActions++;if(b&&typeof b.batches!="undefined"&&b.batches){for(var c=0;c<b.batches.length;c++){if(b.batches[c].length){this.totalActions+=b.batches[c].length;this.queue.push(b.batches[c])}}}this.updateProgressBar();while(this.loadingActions<Craft.Tool.maxConcurrentActions&&this.currentBatchQueue.length){this.loadNextAction()}if(!this.loadingActions){if(this.queue.length){this.currentBatchQueue=this.queue.shift();this.loadNextAction()}else{if(b&&typeof b.backupFile!="undefined"&&b.backupFile){var d=a("<iframe/>",{src:Craft.getActionUrl("tools/downloadBackupFile",{fileName:b.backupFile})}).hide();this.$form.append(d)}setTimeout(a.proxy(this,"onComplete"),300)}}},loadNextAction:function(){var b=this.currentBatchQueue.shift();this.loadAction(b)},onComplete:function(){if(!this.$allDone){this.$allDone=a('<div class="alldone" data-icon="âˆš" />').appendTo(this.hud.$body)}this.$allDone.css({top:Math.round(this.hud.$body.outerHeight()/2)-30});this.$progressBar.animate({left:-170},"fast");this.$allDone.animate({left:30},"fast")}},{maxConcurrentActions:3})})(jQuery);